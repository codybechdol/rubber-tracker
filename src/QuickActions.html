<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { box-sizing: border-box; font-family: 'Google Sans', Arial, sans-serif; }
    body { margin: 0; padding: 12px; background: #f8f9fa; }
    h2 { color: #1a73e8; margin: 0 0 12px 0; font-size: 16px; font-weight: 500; }
    .step-container { margin-bottom: 8px; }
    .step-btn {
      display: flex; align-items: center; width: 100%; padding: 14px 12px;
      border: 1px solid #dadce0; border-radius: 8px; font-size: 14px; font-weight: 500;
      cursor: pointer; text-align: left; background: white; color: #202124;
    }
    .step-btn:hover:not(:disabled) { background: #e8f0fe; border-color: #1a73e8; }
    .step-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .step-btn.running { background: #e8f0fe; border-color: #1a73e8; }
    .step-btn.done { background: #e6f4ea; border-color: #34a853; }
    .step-num {
      width: 24px; height: 24px; background: #1a73e8; color: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 600; margin-right: 12px;
    }
    .step-btn.done .step-num { background: #34a853; }
    .step-btn.done .step-num::after { content: '‚úì'; }
    .step-btn.done .step-num span { display: none; }
    .step-text { flex: 1; }
    .step-subtitle { font-size: 11px; color: #5f6368; margin-top: 2px; }
    .divider { height: 1px; background: #dadce0; margin: 16px 0; }
    .section-title { font-size: 11px; font-weight: 600; color: #5f6368; text-transform: uppercase; margin-bottom: 8px; }
    .quick-btn {
      display: inline-block; padding: 8px 12px; margin: 4px 4px 4px 0;
      border: 1px solid #dadce0; border-radius: 16px; font-size: 12px;
      cursor: pointer; background: white; color: #5f6368;
    }
    .quick-btn:hover:not(:disabled) { background: #f1f3f4; }
    .quick-btn:disabled { opacity: 0.5; }
    .status-bar {
      position: fixed; bottom: 0; left: 0; right: 0; padding: 10px 12px;
      background: #e8f0fe; color: #1a73e8; font-size: 12px; display: none;
    }
    .status-bar.show { display: block; }
    .status-bar.error { background: #fce8e6; color: #c5221f; }
    .status-bar.success { background: #e6f4ea; color: #137333; }
    .reset-link { display: block; text-align: center; margin-top: 12px; font-size: 11px; color: #5f6368; cursor: pointer; }
    .form-group { margin-bottom: 10px; }
    .form-label { display: block; font-size: 11px; font-weight: 500; color: #5f6368; margin-bottom: 4px; }
    .form-input {
      width: 100%; padding: 8px 10px; border: 1px solid #dadce0; border-radius: 4px;
      font-size: 13px; background: #f8f9fa;
    }
    .form-input:focus { outline: none; border-color: #1a73e8; background: #fff; }
    .btn { margin-top: 8px; padding: 10px 24px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn:hover { background: #1557b0; }
    .btn:disabled { background: #dadce0; cursor: not-allowed; }
  </style>
</head>
<body>
  <h2>üß§ Workflow Steps</h2>

  <div class="step-container">
    <button class="step-btn" id="step1" onclick="runStep(1, 'generateAllReports')">
      <span class="step-num"><span>1</span></span>
      <div class="step-text">Generate All Reports<div class="step-subtitle">Swaps, Purchase Needs, Reclaims</div></div>
    </button>
  </div>

  <div class="step-container">
    <button class="step-btn" id="step2" onclick="runStep(2, 'generateSmartSchedule')">
      <span class="step-num"><span>2</span></span>
      <div class="step-text">Create Smart Schedule<div class="step-subtitle">To-Do List by location</div></div>
    </button>
  </div>

  <div class="step-container">
    <button class="step-btn" id="step3" onclick="runStep(3, 'saveHistory')">
      <span class="step-num"><span>3</span></span>
      <div class="step-text">Save to History<div class="step-subtitle">Record current state</div></div>
    </button>
  </div>

  <div class="step-container">
    <button class="step-btn" id="step4" onclick="runStep(4, 'createBackupSnapshot')">
      <span class="step-num"><span>4</span></span>
      <div class="step-text">Create Backup<div class="step-subtitle">Save to Drive</div></div>
    </button>
  </div>

  <div class="reset-link" onclick="resetSteps()">‚Ü∫ Reset workflow</div>

  <div class="divider"></div>
  <div class="section-title">As Needed</div>
  <div>
    <button class="quick-btn" onclick="runQuick('setupCrewVisitConfig', 'Setup Crew Visit Config', 'Setting up Crew Visit Config...')">üë∑ Crew Visit Config</button>
    <button class="quick-btn" onclick="runQuick('setupTrainingConfig', 'Setup Training Config', 'Setting up Training Config...')">üìö Training Config</button>
    <button class="quick-btn" onclick="runQuick('setupTrainingTracking', 'Setup Training Tracking', 'Setting up Training Tracking...')">üìã Training Tracking</button>
    <button class="quick-btn" onclick="runQuick('showExpiringCertsChoiceDialog', 'Manage Certs', 'Opening certification management...')">üìú Manage Certs</button>
  </div>

  <div class="divider"></div>
  <div class="section-title">Quick Actions</div>
  <div>
    <button class="quick-btn" onclick="runQuick('generateGloveSwaps', 'Generate Glove Swaps', 'Updating Glove Swaps report...')">üß§ Gloves</button>
    <button class="quick-btn" onclick="runQuick('generateSleeveSwaps', 'Generate Sleeve Swaps', 'Updating Sleeve Swaps report...')">üí™ Sleeves</button>
    <button class="quick-btn" onclick="runQuick('updatePurchaseNeeds', 'Update Purchase Needs', 'Calculating purchase requirements...')">üõí Purchase</button>
    <button class="quick-btn" onclick="runQuick('showItemHistoryLookup', 'Item History Lookup', 'Opening history lookup dialog...')">üîç Lookup</button>
    <button class="quick-btn" onclick="openToDoSchedule()">üìÖ To Do Schedule</button>
    <button class="quick-btn" onclick="openToDoConfig()">‚öôÔ∏è To Do Config</button>
  </div>

  <div class="divider"></div>
  <div class="section-title" onclick="toggleManualTask()" style="cursor:pointer;">
    üìÖ Add Manual Schedule Item <span id="expandIcon">‚ñº</span>
  </div>
  <div id="manualTaskForm" style="display:none; background:#fff; padding:12px; border-radius:8px; border:1px solid #dadce0;">
    <div class="form-group">
      <label class="form-label">Location</label>
      <input type="text" id="mtLocation" class="form-input" placeholder="e.g., Office, Home, Client Site">
    </div>
    <div class="form-group">
      <label class="form-label">Priority</label>
      <select id="mtPriority" class="form-input">
        <option value="High">üî¥ High</option>
        <option value="Medium" selected>üü° Medium</option>
        <option value="Low">üü¢ Low</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Task Type / Title</label>
      <input type="text" id="mtTaskType" class="form-input" placeholder="e.g., Meeting with John, Doctor Appointment">
    </div>
    <div class="form-group">
      <label class="form-label">Scheduled Date</label>
      <input type="date" id="mtScheduledDate" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">Start Time</label>
      <input type="time" id="mtStartTime" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">End Time (optional)</label>
      <input type="time" id="mtEndTime" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">Estimated Time (hours)</label>
      <input type="number" id="mtEstimatedTime" class="form-input" placeholder="e.g., 4" step="0.5" min="0.5">
    </div>
    <div class="form-group">
      <label class="form-label">Start Location</label>
      <input type="text" id="mtStartLocation" class="form-input" placeholder="Where you're coming from">
    </div>
    <div class="form-group">
      <label class="form-label">End Location</label>
      <input type="text" id="mtEndLocation" class="form-input" placeholder="Where you're going after">
    </div>
    <div class="form-group">
      <label class="form-label">Notes (optional)</label>
      <input type="text" id="mtNotes" class="form-input" placeholder="Additional details...">
    </div>
    <button class="btn" onclick="addManualTask()" style="width:100%;">‚ûï Add to Schedule</button>
  </div>

  <div id="statusBar" class="status-bar"></div>

  <script>
    function runStep(n, func) {
      var btn = document.getElementById('step' + n);
      btn.classList.add('running'); btn.disabled = true;
      showStatus('Running Step ' + n + '...');
      google.script.run.withSuccessHandler(function() {
        btn.classList.remove('running'); btn.classList.add('done'); btn.disabled = false;
        showStatus('‚úì Step ' + n + ' complete!', 'success');
        setTimeout(hideStatus, 2000);
      }).withFailureHandler(function(e) {
        btn.classList.remove('running'); btn.disabled = false;
        showStatus('Error: ' + e, 'error');
      })[func]();
    }
    function runQuick(func, title, message) {
      document.querySelectorAll('.quick-btn').forEach(function(b){b.disabled=true;});
      showStatus('‚è≥ ' + message);
      google.script.run.withSuccessHandler(function() {
        document.querySelectorAll('.quick-btn').forEach(function(b){b.disabled=false;});
        showStatus('‚úì ' + title + ' complete!', 'success'); setTimeout(hideStatus, 2000);
      }).withFailureHandler(function(e) {
        document.querySelectorAll('.quick-btn').forEach(function(b){b.disabled=false;});
        showStatus('Error: ' + e, 'error');
      })[func]();
    }
    function resetSteps() {
      for(var i=1;i<=4;i++){var b=document.getElementById('step'+i);b.classList.remove('done','running');b.disabled=false;}
      showStatus('Reset', 'success'); setTimeout(hideStatus, 1500);
    }
    function showStatus(m, t) { var s=document.getElementById('statusBar'); s.textContent=m; s.className='status-bar show '+(t||''); }
    function hideStatus() { document.getElementById('statusBar').className='status-bar'; }

    function openToDoConfig() {
      showStatus('‚è≥ Opening To Do Config...');
      google.script.run.withSuccessHandler(function() {
        hideStatus();
      }).withFailureHandler(function(e) {
        showStatus('Error: ' + e, 'error');
      }).showToDoConfig();
    }

    function openToDoSchedule() {
      showStatus('‚è≥ Opening To Do Schedule...');
      google.script.run.withSuccessHandler(function() {
        hideStatus();
      }).withFailureHandler(function(e) {
        showStatus('Error: ' + e, 'error');
      }).showToDoSchedule();
    }

    function toggleManualTask() {
      var form = document.getElementById('manualTaskForm');
      var icon = document.getElementById('expandIcon');
      if (form.style.display === 'none') {
        form.style.display = 'block';
        icon.textContent = '‚ñ≤';
        // Set default date to today
        var today = new Date().toISOString().split('T')[0];
        document.getElementById('mtScheduledDate').value = today;
      } else {
        form.style.display = 'none';
        icon.textContent = '‚ñº';
      }
    }

    function addManualTask() {
      var location = document.getElementById('mtLocation').value.trim();
      var priority = document.getElementById('mtPriority').value;
      var taskType = document.getElementById('mtTaskType').value;
      var scheduledDate = document.getElementById('mtScheduledDate').value;
      var startTime = document.getElementById('mtStartTime').value;
      var endTime = document.getElementById('mtEndTime').value;
      var estimatedTime = document.getElementById('mtEstimatedTime').value;
      var startLocation = document.getElementById('mtStartLocation').value.trim();
      var endLocation = document.getElementById('mtEndLocation').value.trim();
      var notes = document.getElementById('mtNotes').value.trim();

      // Validation
      if (!location) { alert('Please enter a location'); return; }
      if (!taskType) { alert('Please enter a task type/title'); return; }
      if (!scheduledDate) { alert('Please select a scheduled date'); return; }
      if (!startTime) { alert('Please enter a start time'); return; }
      if (!estimatedTime || estimatedTime <= 0) { alert('Please enter estimated time (hours)'); return; }

      var taskData = {
        location: location,
        priority: priority,
        taskType: taskType,
        scheduledDate: scheduledDate,
        startTime: startTime,
        endTime: endTime || '',
        estimatedTime: parseFloat(estimatedTime),
        startLocation: startLocation,
        endLocation: endLocation,
        notes: notes
      };

      showStatus('‚è≥ Adding to schedule...');

      google.script.run
        .withSuccessHandler(function(result) {
          showStatus('‚úì Added to Smart Schedule!', 'success');
          setTimeout(hideStatus, 2000);
          // Clear form
          document.getElementById('mtLocation').value = '';
          document.getElementById('mtTaskType').value = '';
          document.getElementById('mtEstimatedTime').value = '';
          document.getElementById('mtStartLocation').value = '';
          document.getElementById('mtEndLocation').value = '';
          document.getElementById('mtNotes').value = '';
        })
        .withFailureHandler(function(error) {
          showStatus('Error: ' + error, 'error');
        })
        .addManualScheduleTask(taskData);
    }
  </script>
</body>
</html>

