<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rubber Tracker Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body { background: linear-gradient(135deg, #e8eef5 0%, #d4e0ed 100%); color: #333; min-height: 100vh; }
    .card { margin: 0.5rem; border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
    .card-body { min-height: 100px; }
    .dashboard-header {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: #1a365d;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .icon { font-size: 2rem; margin-bottom: 5px; }
    .emoji-icon { font-size: 2.2rem; margin-bottom: 5px; }
    .table th, .table td { text-align: center; vertical-align: middle; }
    .bar-cell { color: #0066cc; text-align: left !important; font-family: monospace; font-weight: bold; }

    /* Clickable elements */
    .clickable { cursor: pointer; transition: all 0.2s; }
    .clickable:hover { transform: scale(1.03); box-shadow: 0 6px 20px rgba(0,0,0,0.25) !important; }
    .clickable-row:hover { background: #cce5ff !important; cursor: pointer; }

    /* Summary Cards */
    .summary-card { color: white; }
    .summary-card h2 { font-size: 2.2rem; margin: 0; font-weight: 700; }
    .class-breakdown { font-size: 0.8rem; opacity: 0.85; margin-top: 5px; }

    .glove-card { background: linear-gradient(135deg, #2c5282 0%, #3182ce 100%); border-left: 4px solid #e94560; }
    .glove-card .emoji-icon { filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3)); }
    .sleeve-card { background: linear-gradient(135deg, #553c9a 0%, #805ad5 100%); border-left: 4px solid #b794f4; }
    .sleeve-card .icon { color: #fff; }
    .assigned-card { background: linear-gradient(135deg, #276749 0%, #48bb78 100%); border-left: 4px solid #9ae6b4; }
    .assigned-card .icon { color: #fff; }
    .shelf-card { background: linear-gradient(135deg, #0987a0 0%, #38b2ac 100%); border-left: 4px solid #81e6d9; }
    .shelf-card .icon { color: #fff; }
    .testing-card { background: linear-gradient(135deg, #f37335 0%, #fdc830 100%); border-left: 4px solid #fff; }
    .testing-card .icon { color: #fff; }
    .overdue-card { background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%); border-left: 4px solid #fff; }
    .overdue-card .icon { color: #fff; }

    /* Purchase Needs Card */
    .purchase-card .card-header {
      background: linear-gradient(90deg, #c53030 0%, #e53e3e 100%);
      color: #fff;
      border-bottom: 3px solid #fc8181;
      border-radius: 12px 12px 0 0 !important;
    }
    .purchase-card .table thead th { background: #fff5f5; color: #c53030; }
    .priority-1 { background: #fed7d7 !important; font-weight: bold; }
    .priority-2 { background: #feebc8 !important; }
    .priority-3 { background: #e9d8fd !important; }

    /* Table Cards */
    .table-card { background: #ffffff; }
    .table-card .card-header {
      background: linear-gradient(90deg, #2c5282 0%, #553c9a 100%);
      color: #fff;
      font-weight: 600;
      border-bottom: 3px solid #e94560;
      border-radius: 12px 12px 0 0 !important;
      padding: 12px 15px;
    }
    .table-card .table { color: #333; margin-bottom: 0; }
    .table-card .table thead th {
      background: linear-gradient(180deg, #edf2f7 0%, #e2e8f0 100%);
      color: #2c5282;
      border-color: #cbd5e0;
      font-weight: 600;
      padding: 10px;
    }
    .table-card .table tbody tr:nth-child(odd) { background: #f7fafc; }
    .table-card .table tbody tr:nth-child(even) { background: #ffffff; }
    .table-card .table tbody tr:hover { background: #ebf8ff; transition: background 0.2s; }
    .table-card .table td { border-color: #e2e8f0; padding: 8px; }

    /* Swaps Card */
    .swaps-card { background: #ffffff; }
    .swaps-card .card-header {
      background: linear-gradient(90deg, #c53030 0%, #e53e3e 100%);
      color: #fff;
      border-radius: 12px 12px 0 0 !important;
      border-bottom: 3px solid #fc8181;
    }
    .swaps-card h6 { color: #c53030; font-weight: 600; margin-top: 10px; }
    .swaps-card .table thead th { background: #fff5f5; color: #c53030; }
    .overdue-summary { background: #fed7d7 !important; font-weight: bold; color: #c53030; }

    /* Class Card */
    .class-card .card-header {
      background: linear-gradient(90deg, #276749 0%, #48bb78 100%);
      border-bottom: 3px solid #9ae6b4;
    }

    /* Location Card */
    .location-card .card-header {
      background: linear-gradient(90deg, #c05621 0%, #ed8936 100%);
      border-bottom: 3px solid #fbd38d;
    }

    /* Detail Modal */
    .modal-header { background: linear-gradient(90deg, #2c5282 0%, #553c9a 100%); color: white; }
    .modal-body { max-height: 60vh; overflow-y: auto; }
    .detail-table th { background: #edf2f7; position: sticky; top: 0; }

    .loading { text-align: center; padding: 3rem; color: #666; font-size: 1.2rem; }
    .error { color: #c53030; text-align: center; padding: 1rem; background: rgba(197,48,48,0.1); border-radius: 8px; }

    .btn-refresh {
      background: linear-gradient(90deg, #00d4ff 0%, #7b2cbf 100%);
      border: none;
      font-weight: 600;
      padding: 10px 30px;
      border-radius: 25px;
    }
    .btn-refresh:hover {
      background: linear-gradient(90deg, #7b2cbf 0%, #00d4ff 100%);
      transform: scale(1.05);
      transition: all 0.3s;
    }
  </style>
</head>
<body>
  <div class="container-fluid py-3">
    <div class="dashboard-header text-center"><i class="bi bi-shield-check"></i> Rubber Tracker Dashboard</div>

    <!-- Loading indicator -->
    <div id="loading" class="loading"><i class="bi bi-arrow-repeat spin"></i> Loading dashboard data...</div>
    <div id="error" class="error" style="display:none;"></div>

    <!-- Main content (hidden until loaded) -->
    <div id="dashboard-content" style="display:none;">

      <!-- Purchase Needs Section -->
      <div class="row g-3 mb-3">
        <div class="col-12">
          <div class="card table-card purchase-card">
            <div class="card-header"><i class="bi bi-cart-fill"></i> Purchase Needs Summary</div>
            <div class="card-body p-0">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Priority</th>
                    <th>Timeframe</th>
                    <th>Gloves</th>
                    <th>Sleeves</th>
                    <th>Total</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="purchase-needs-table"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Cards Row -->
      <div class="row g-2 mb-3">
        <div class="col-6 col-md-2">
          <div class="card summary-card glove-card clickable" onclick="showDetailModal('gloves', 'all')">
            <div class="card-body text-center py-2">
              <div class="emoji-icon">ðŸ–•</div>
              <h6 class="card-title mb-0">Gloves</h6>
              <h2 id="gloves-total">0</h2>
              <div id="gloves-class-breakdown" class="class-breakdown"></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card summary-card sleeve-card clickable" onclick="showDetailModal('sleeves', 'all')">
            <div class="card-body text-center py-2">
              <div class="icon"><i class="bi bi-lightning-charge-fill"></i></div>
              <h6 class="card-title mb-0">Sleeves</h6>
              <h2 id="sleeves-total">0</h2>
              <div id="sleeves-class-breakdown" class="class-breakdown"></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card summary-card assigned-card clickable" onclick="showDetailModal('both', 'Assigned')">
            <div class="card-body text-center py-2">
              <div class="icon"><i class="bi bi-person-fill-check"></i></div>
              <h6 class="card-title mb-0">Assigned</h6>
              <h2 id="assigned-total">0</h2>
              <div id="assigned-class-breakdown" class="class-breakdown"></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card summary-card shelf-card clickable" onclick="showDetailModal('both', 'On Shelf')">
            <div class="card-body text-center py-2">
              <div class="icon"><i class="bi bi-box-seam-fill"></i></div>
              <h6 class="card-title mb-0">On Shelf</h6>
              <h2 id="shelf-total">0</h2>
              <div id="shelf-class-breakdown" class="class-breakdown"></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card summary-card testing-card clickable" onclick="showDetailModal('both', 'Testing')">
            <div class="card-body text-center py-2">
              <div class="icon"><i class="bi bi-clipboard2-pulse-fill"></i></div>
              <h6 class="card-title mb-0">Testing</h6>
              <h2 id="testing-total">0</h2>
              <div id="testing-class-breakdown" class="class-breakdown"></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card summary-card overdue-card clickable" onclick="showDetailModal('both', 'Overdue')">
            <div class="card-body text-center py-2">
              <div class="icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
              <h6 class="card-title mb-0">Overdue</h6>
              <h2 id="overdue-total">0</h2>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Tables Row -->
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card table-card">
            <div class="card-header"><i class="bi bi-bar-chart-fill"></i> Gloves by Status</div>
            <div class="card-body p-0">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Status</th>
                    <th>Count</th>
                    <th>%</th>
                    <th style="text-align:left;">Bar</th>
                  </tr>
                </thead>
                <tbody id="gloves-status-table"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card table-card">
            <div class="card-header"><i class="bi bi-bar-chart-fill"></i> Sleeves by Status</div>
            <div class="card-body p-0">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Status</th>
                    <th>Count</th>
                    <th>%</th>
                    <th style="text-align:left;">Bar</th>
                  </tr>
                </thead>
                <tbody id="sleeves-status-table"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Class Breakdown Row -->
      <div class="row g-3 mt-2">
        <div class="col-12 col-md-6">
          <div class="card table-card class-card">
            <div class="card-header"><i class="bi bi-layers-fill"></i> Inventory by Class</div>
            <div class="card-body p-0">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Class</th>
                    <th>Gloves</th>
                    <th>Sleeves</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="class-table"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="card table-card location-card">
            <div class="card-header"><i class="bi bi-geo-alt-fill"></i> Top Locations</div>
            <div class="card-body p-0">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Location</th>
                    <th>Gloves</th>
                    <th>Sleeves</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="location-table"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Swaps Due Soon -->
      <div class="row g-3 mt-2">
        <div class="col-12">
          <div class="card table-card swaps-card">
            <div class="card-header"><i class="bi bi-alarm-fill"></i> Upcoming & Overdue Swaps</div>
            <div class="card-body p-2">
              <div class="row">
                <div class="col-12 col-md-6">
                  <h6><i class="bi bi-hand-index-thumb"></i> Glove Swaps</h6>
                  <table class="table table-sm mb-0">
                    <thead><tr><th>Employee</th><th>Item#</th><th>Size</th><th>Class</th><th>Change Out</th><th>Days Left</th><th>Status</th></tr></thead>
                    <tbody id="glove-swaps-table"></tbody>
                  </table>
                </div>
                <div class="col-12 col-md-6">
                  <h6><i class="bi bi-lightning-charge"></i> Sleeve Swaps</h6>
                  <table class="table table-sm mb-0">
                    <thead><tr><th>Employee</th><th>Item#</th><th>Size</th><th>Class</th><th>Change Out</th><th>Days Left</th><th>Status</th></tr></thead>
                    <tbody id="sleeve-swaps-table"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reclaims & To-Do Summary Row -->
      <div class="row g-3 mt-2">
        <div class="col-12 col-md-6">
          <div class="card table-card">
            <div class="card-header" style="background: linear-gradient(90deg, #e65100 0%, #ff9800 100%); border-bottom: 3px solid #ffcc80;"><i class="bi bi-arrow-repeat"></i> Reclaims Summary</div>
            <div class="card-body p-0">
              <table class="table table-sm mb-0">
                <tbody id="reclaims-summary-table"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="card table-card">
            <div class="card-header" style="background: linear-gradient(90deg, #7b1fa2 0%, #ab47bc 100%); border-bottom: 3px solid #ce93d8;"><i class="bi bi-list-check"></i> To-Do Summary</div>
            <div class="card-body p-0">
              <table class="table table-sm mb-0">
                <tbody id="todo-summary-table"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Refresh Button -->
      <div class="row mt-3">
        <div class="col text-center">
          <button class="btn btn-refresh text-white" onclick="refreshDashboard()"><i class="bi bi-arrow-clockwise"></i> Refresh Data</button>
          <small class="d-block text-muted mt-1">Auto-refreshes every 5 minutes</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailModalTitle">Item Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table class="table table-sm table-striped detail-table">
            <thead id="detail-table-head"></thead>
            <tbody id="detail-table-body"></tbody>
          </table>
        </div>
        <div class="modal-footer">
          <span id="detail-count" class="me-auto text-muted"></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Store data globally for click handlers
    var dashboardData = {};

    function updateSummaryCards(data) {
      var summary = data.summary || {};
      document.getElementById('gloves-total').textContent = summary.totalGloves || 0;
      document.getElementById('sleeves-total').textContent = summary.totalSleeves || 0;
      document.getElementById('assigned-total').textContent = summary.totalAssigned || 0;
      document.getElementById('shelf-total').textContent = summary.totalOnShelf || 0;
      document.getElementById('testing-total').textContent = summary.totalTesting || 0;
      document.getElementById('overdue-total').textContent = summary.totalOverdue || 0;

      // Class breakdown for gloves and sleeves
      var classData = data.classData || [];
      var glovesBreakdown = classData.map(function(c) { return c.class.replace('Class ', 'C') + ': ' + c.gloves; }).join(' | ');
      var sleevesBreakdown = classData.map(function(c) { return c.class.replace('Class ', 'C') + ': ' + c.sleeves; }).join(' | ');
      document.getElementById('gloves-class-breakdown').innerHTML = glovesBreakdown;
      document.getElementById('sleeves-class-breakdown').innerHTML = sleevesBreakdown;

      // Class breakdowns for Assigned, On Shelf, Testing
      var assignedByClass = summary.assignedByClass || { 0: 0, 2: 0, 3: 0 };
      var onShelfByClass = summary.onShelfByClass || { 0: 0, 2: 0, 3: 0 };
      var testingByClass = summary.testingByClass || { 0: 0, 2: 0, 3: 0 };

      var assignedBreakdown = 'C0: ' + (assignedByClass[0] || 0) + ' | C2: ' + (assignedByClass[2] || 0) + ' | C3: ' + (assignedByClass[3] || 0);
      var shelfBreakdown = 'C0: ' + (onShelfByClass[0] || 0) + ' | C2: ' + (onShelfByClass[2] || 0) + ' | C3: ' + (onShelfByClass[3] || 0);
      var testingBreakdown = 'C0: ' + (testingByClass[0] || 0) + ' | C2: ' + (testingByClass[2] || 0) + ' | C3: ' + (testingByClass[3] || 0);

      document.getElementById('assigned-class-breakdown').innerHTML = assignedBreakdown;
      document.getElementById('shelf-class-breakdown').innerHTML = shelfBreakdown;
      document.getElementById('testing-class-breakdown').innerHTML = testingBreakdown;
    }

    function updatePurchaseNeedsTable(purchaseData) {
      var tbody = document.getElementById('purchase-needs-table');
      tbody.innerHTML = '';
      if (!purchaseData || purchaseData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-success"><i class="bi bi-check-circle"></i> No purchase needs!</td></tr>';
        return;
      }
      purchaseData.forEach(function(row) {
        var priorityClass = row.priority === 1 ? 'priority-1' : (row.priority === 2 ? 'priority-2' : 'priority-3');
        tbody.innerHTML += '<tr class="clickable-row ' + priorityClass + '" onclick="showPurchaseDetail(\'' + row.status + '\')">' +
          '<td>' + row.priority + '</td>' +
          '<td>' + row.timeframe + '</td>' +
          '<td>' + (row.gloves || 0) + '</td>' +
          '<td>' + (row.sleeves || 0) + '</td>' +
          '<td><strong>' + row.total + '</strong></td>' +
          '<td>' + row.status + '</td>' +
          '</tr>';
      });
    }

    function updateStatusTable(tableId, statusData, total, itemType) {
      var tbody = document.getElementById(tableId);
      tbody.innerHTML = '';
      if (!statusData || statusData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-muted">No data</td></tr>';
        return;
      }
      // Sort by count descending (most to least)
      statusData.sort(function(a, b) { return b.count - a.count; });
      statusData.forEach(function(row) {
        var barCount = Math.round(row.percent / 5);
        var bar = '<span style="color:#0066cc;">|</span>'.repeat(barCount);
        tbody.innerHTML += '<tr class="clickable-row" onclick="showDetailModal(\'' + itemType + '\', \'' + row.status + '\')">' +
          '<td>' + row.status + '</td>' +
          '<td>' + row.count + '</td>' +
          '<td>' + row.percent + '%</td>' +
          '<td class="bar-cell">' + bar + '</td>' +
          '</tr>';
      });
    }

    function updateClassTable(classData) {
      var tbody = document.getElementById('class-table');
      tbody.innerHTML = '';
      if (!classData || classData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-muted">No data</td></tr>';
        return;
      }
      classData.forEach(function(row) {
        tbody.innerHTML += '<tr class="clickable-row" onclick="showDetailModal(\'both\', \'class\', \'' + row.class + '\')">' +
          '<td>' + row.class + '</td>' +
          '<td>' + row.gloves + '</td>' +
          '<td>' + row.sleeves + '</td>' +
          '<td><strong>' + row.total + '</strong></td>' +
          '</tr>';
      });
    }

    function updateLocationTable(locationData) {
      var tbody = document.getElementById('location-table');
      tbody.innerHTML = '';
      if (!locationData || locationData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-muted">No data</td></tr>';
        return;
      }
      locationData.forEach(function(row) {
        tbody.innerHTML += '<tr class="clickable-row" onclick="showDetailModal(\'both\', \'location\', \'' + row.location + '\')">' +
          '<td>' + row.location + '</td>' +
          '<td>' + row.gloves + '</td>' +
          '<td>' + row.sleeves + '</td>' +
          '<td><strong>' + row.total + '</strong></td>' +
          '</tr>';
      });
    }

    function updateSwapsTable(tableId, swapsData, itemType) {
      var tbody = document.getElementById(tableId);
      tbody.innerHTML = '';
      if (!swapsData || swapsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-success"><i class="bi bi-check-circle"></i> None due soon</td></tr>';
        return;
      }

      // Separate overdue from upcoming
      var overdueItems = swapsData.filter(function(row) { return row.daysLeft === 'OVERDUE'; });
      var upcomingItems = swapsData.filter(function(row) { return row.daysLeft !== 'OVERDUE'; });

      // Add consolidated overdue row if any
      if (overdueItems.length > 0) {
        tbody.innerHTML += '<tr class="overdue-summary clickable-row" onclick="showDetailModal(\'' + itemType + '\', \'Overdue\')">' +
          '<td colspan="4"><i class="bi bi-exclamation-triangle-fill"></i> OVERDUE ITEMS</td>' +
          '<td>' + overdueItems.length + ' items</td>' +
          '<td colspan="2">Click to view</td>' +
          '</tr>';
      }

      // Add upcoming items (limit to 8)
      upcomingItems.slice(0, 8).forEach(function(row) {
        var daysClass = row.daysLeft <= 7 ? 'text-warning fw-bold' : '';
        tbody.innerHTML += '<tr class="clickable-row" onclick="showItemDetail(\'' + itemType + '\', \'' + row.itemNum + '\')">' +
          '<td>' + row.employee + '</td>' +
          '<td>' + row.itemNum + '</td>' +
          '<td>' + (row.size || '') + '</td>' +
          '<td>' + (row.classVal || '') + '</td>' +
          '<td>' + (row.changeOutDate || '') + '</td>' +
          '<td class="' + daysClass + '">' + row.daysLeft + '</td>' +
          '<td>' + (row.status || '') + '</td>' +
          '</tr>';
      });
    }

    function showDetailModal(itemType, filterType, filterValue) {
      var title = '';
      var items = [];
      var gloves = dashboardData.rawGloves || [];
      var sleeves = dashboardData.rawSleeves || [];

      if (itemType === 'gloves') {
        items = filterItems(gloves, filterType, filterValue, 'Glove');
        title = 'Gloves' + (filterType !== 'all' ? ' - ' + (filterValue || filterType) : '');
      } else if (itemType === 'sleeves') {
        items = filterItems(sleeves, filterType, filterValue, 'Sleeve');
        title = 'Sleeves' + (filterType !== 'all' ? ' - ' + (filterValue || filterType) : '');
      } else {
        items = filterItems(gloves, filterType, filterValue, 'Glove')
          .concat(filterItems(sleeves, filterType, filterValue, 'Sleeve'));
        title = (filterValue || filterType) + ' Items';
      }

      document.getElementById('detailModalTitle').textContent = title;
      document.getElementById('detail-count').textContent = items.length + ' items';

      var thead = document.getElementById('detail-table-head');
      thead.innerHTML = '<tr><th>Type</th><th>Item#</th><th>Size</th><th>Class</th><th>Location</th><th>Status</th><th>Assigned To</th><th>Date Assigned</th><th>Change Out</th></tr>';

      var tbody = document.getElementById('detail-table-body');
      tbody.innerHTML = '';
      items.forEach(function(item) {
        tbody.innerHTML += '<tr>' +
          '<td>' + item.type + '</td>' +
          '<td><strong>' + item.itemNum + '</strong></td>' +
          '<td>' + item.size + '</td>' +
          '<td>' + item.class + '</td>' +
          '<td>' + item.location + '</td>' +
          '<td>' + item.status + '</td>' +
          '<td>' + item.assignedTo + '</td>' +
          '<td>' + item.dateAssigned + '</td>' +
          '<td>' + item.changeOutDate + '</td>' +
          '</tr>';
      });

      var modal = new bootstrap.Modal(document.getElementById('detailModal'));
      modal.show();
    }

    function filterItems(items, filterType, filterValue, type) {
      return items.filter(function(item) {
        if (filterType === 'all') return true;
        if (filterType === 'Assigned') return item.status && item.status.toLowerCase() === 'assigned';
        if (filterType === 'On Shelf') return item.status && item.status.toLowerCase() === 'on shelf';
        if (filterType === 'Testing') {
          var st = item.status ? item.status.toLowerCase() : '';
          return st === 'in testing' || st === 'ready for test' || st === 'ready for testing';
        }
        if (filterType === 'Overdue') return item.isOverdue;
        if (filterType === 'class') return item.class === filterValue || 'Class ' + item.class === filterValue;
        if (filterType === 'location') return item.location === filterValue;
        if (filterType === item.status) return true;
        return item.status && item.status.toLowerCase() === filterType.toLowerCase();
      }).map(function(item) {
        item.type = type;
        return item;
      });
    }

    function showItemDetail(itemType, itemNum) {
      var items = itemType === 'gloves' ? dashboardData.rawGloves : dashboardData.rawSleeves;
      var item = items.find(function(i) { return String(i.itemNum) === String(itemNum); });
      if (item) {
        showDetailModal(itemType, 'all');
      }
    }

    function showPurchaseDetail(status) {
      // Show items that need to be purchased based on status
      showDetailModal('both', status);
    }

    function updateReclaimsSummaryTable(reclaimsData) {
      var tbody = document.getElementById('reclaims-summary-table');
      tbody.innerHTML = '';
      if (!reclaimsData || reclaimsData.total === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="text-success text-center p-3"><i class="bi bi-check-circle"></i> No reclaims needed!</td></tr>';
        return;
      }
      var rows = [
        { label: 'âš ï¸ Class 3 Reclaims (Need CL2)', count: reclaimsData.class3 || 0, color: '#fff3e0' },
        { label: 'âš ï¸ Class 2 Reclaims (Need CL3)', count: reclaimsData.class2 || 0, color: '#e3f2fd' },
        { label: 'ðŸ‘¤ Previous Employee Items', count: reclaimsData.prevEmployee || 0, color: '#fce4ec' },
        { label: 'ðŸ” Lost Items', count: reclaimsData.lost || 0, color: '#ffebee' }
      ];
      rows.forEach(function(row) {
        if (row.count > 0) {
          tbody.innerHTML += '<tr style="background: ' + row.color + ';">' +
            '<td style="padding: 8px;">' + row.label + '</td>' +
            '<td style="padding: 8px; text-align: center; font-weight: bold;">' + row.count + '</td>' +
            '</tr>';
        }
      });
      tbody.innerHTML += '<tr style="background: #e0e0e0; font-weight: bold;">' +
        '<td style="padding: 8px;">Total Reclaims</td>' +
        '<td style="padding: 8px; text-align: center;">' + reclaimsData.total + '</td>' +
        '</tr>';
    }

    function updateTodoSummaryTable(todoData) {
      var tbody = document.getElementById('todo-summary-table');
      tbody.innerHTML = '';
      if (!todoData || todoData.total === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="text-success text-center p-3"><i class="bi bi-check-circle"></i> All tasks complete!</td></tr>';
        return;
      }
      var rows = [
        { label: 'ðŸ”´ High Priority', count: todoData.high || 0, color: '#ffcdd2' },
        { label: 'ðŸŸ  Medium Priority', count: todoData.medium || 0, color: '#ffe0b2' },
        { label: 'ðŸŸ¢ Low Priority', count: todoData.low || 0, color: '#c8e6c9' },
        { label: 'âœ… Completed', count: todoData.completed || 0, color: '#e8f5e9' }
      ];
      rows.forEach(function(row) {
        tbody.innerHTML += '<tr style="background: ' + row.color + ';">' +
          '<td style="padding: 8px;">' + row.label + '</td>' +
          '<td style="padding: 8px; text-align: center; font-weight: bold;">' + row.count + '</td>' +
          '</tr>';
      });
      tbody.innerHTML += '<tr style="background: #e0e0e0; font-weight: bold;">' +
        '<td style="padding: 8px;">Pending Tasks</td>' +
        '<td style="padding: 8px; text-align: center;">' + todoData.total + '</td>' +
        '</tr>';
    }

    function refreshDashboard() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';
      document.getElementById('dashboard-content').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(data) {
          document.getElementById('loading').style.display = 'none';
          if (data.error) {
            document.getElementById('error').textContent = 'Error: ' + data.error;
            document.getElementById('error').style.display = 'block';
            return;
          }
          document.getElementById('dashboard-content').style.display = 'block';

          // Store data globally for click handlers
          dashboardData = data;

          updateSummaryCards(data);
          updatePurchaseNeedsTable(data.purchaseNeeds);
          updateStatusTable('gloves-status-table', data.statusData ? data.statusData.gloves : [], data.summary ? data.summary.totalGloves : 0, 'gloves');
          updateStatusTable('sleeves-status-table', data.statusData ? data.statusData.sleeves : [], data.summary ? data.summary.totalSleeves : 0, 'sleeves');
          updateClassTable(data.classData);
          updateLocationTable(data.locationData);
          updateSwapsTable('glove-swaps-table', data.gloveSwaps, 'gloves');
          updateSwapsTable('sleeve-swaps-table', data.sleeveSwaps, 'sleeves');
          updateReclaimsSummaryTable(data.reclaimsSummary);
          updateTodoSummaryTable(data.todoSummary);
        })
        .withFailureHandler(function(err) {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('error').textContent = 'Failed to load data: ' + err;
          document.getElementById('error').style.display = 'block';
        })
        .getDashboardData();
    }

    // Auto-refresh every 5 minutes
    setInterval(refreshDashboard, 5 * 60 * 1000);

    // Initial load
    refreshDashboard();
  </script>
</body>
</html>

