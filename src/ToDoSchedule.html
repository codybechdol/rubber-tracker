<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>To Do Schedule</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body { font-family: 'Google Sans', Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header h1 { color: #5f6368; font-size: 24px; margin: 0; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
    .btn-primary:hover { background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%); border: none; }
    .nav-tabs .nav-link { color: #5f6368; }
    .nav-tabs .nav-link.active { color: #667eea; border-color: #667eea; border-bottom-color: white; }
    .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px; border-radius: 12px; overflow: hidden; }
    .card-header { background: #667eea; color: white; font-weight: 500; }
    .task-row { padding: 12px; border-bottom: 1px solid #e0e0e0; }
    .task-row:last-child { border-bottom: none; }
    .task-row:hover { background: #f1f3f4; }
    .priority-high { border-left: 4px solid #ea4335; }
    .priority-medium { border-left: 4px solid #fbbc04; }
    .priority-low { border-left: 4px solid #34a853; }
    .task-date { font-size: 12px; color: #5f6368; }
    .task-location { font-weight: 500; color: #202124; }
    .task-type { color: #5f6368; font-size: 13px; }
    .task-source { font-size: 11px; color: #9aa0a6; }
    .loading { text-align: center; padding: 40px; }
    .empty-state { text-align: center; padding: 60px; color: #5f6368; }
    .date-input { border: 1px solid #dadce0; border-radius: 4px; padding: 4px 8px; font-size: 13px; width: 130px; }
    .date-input:focus { outline: none; border-color: #1a73e8; }
    .status-badge { font-size: 11px; padding: 2px 8px; border-radius: 12px; }
    .status-pending { background: #fef7e0; color: #b06000; }
    .status-complete { background: #e6f4ea; color: #137333; }
    .status-overdue { background: #fce8e6; color: #c5221f; }
    .status-scheduled { background: #e8f0fe; color: #1967d2; }
    .filter-bar { background: white; padding: 12px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }

    /* Calendar Styles */
    .calendar-container { background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .calendar-title { font-size: 18px; font-weight: 500; color: #202124; }
    .calendar-nav { display: flex; gap: 8px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day-header { text-align: center; font-weight: 500; color: #5f6368; padding: 8px; font-size: 12px; }
    .calendar-day { min-height: 80px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 4px; background: #fff; cursor: pointer; }
    .calendar-day:hover { background: #f1f3f4; }
    .calendar-day.today { background: #fff59d; border-color: #f57c00; }
    .calendar-day.other-month { background: #f5f5f5; color: #9e9e9e; }
    .calendar-day.has-tasks { background: #e3f2fd; }
    .calendar-day-number { font-weight: 500; font-size: 14px; margin-bottom: 4px; }
    .calendar-task-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 2px; }
    .calendar-task-dot.high { background: #ea4335; }
    .calendar-task-dot.medium { background: #fbbc04; }
    .calendar-task-dot.low { background: #34a853; }
    .calendar-task-preview { font-size: 10px; color: #5f6368; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .calendar-task-location { font-size: 9px; color: #667eea; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .day-detail-popup { position: fixed; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); padding: 16px; z-index: 1000; max-width: 450px; max-height: 500px; overflow-y: auto; }
    .day-detail-task { border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px; margin-bottom: 8px; }
    .day-detail-task.priority-high { border-left: 4px solid #ea4335; }
    .day-detail-task.priority-medium { border-left: 4px solid #fbbc04; }
    .day-detail-task.priority-low { border-left: 4px solid #34a853; }
    .unsaved-indicator { display: none; color: #dc3545; font-size: 12px; margin-left: 8px; }
    .unsaved-indicator.show { display: inline; }
    .date-input.changed { background: #fff3cd; border-color: #ffc107; }

    /* Personal Checklist Styles */
    .list-group-item { transition: all 0.2s ease; }
    .list-group-item:hover { background: #f8f9fa; }
    .list-group-item-success { background: #d4edda !important; }
    #checklistBadge { font-size: 10px; padding: 2px 6px; margin-left: 4px; }

    /* Time Input Styles */
    .time-input { border: 1px solid #dadce0; border-radius: 4px; padding: 4px 8px; font-size: 12px; width: 85px; }
    .time-input:focus { outline: none; border-color: #1a73e8; }
    .time-input.changed { background: #fff3cd; border-color: #ffc107; }

    /* Bulk Edit Button Styles */
    .bulk-edit-btn { font-size: 11px; padding: 2px 8px; }
    .location-edit-section { background: #f8f9fa; border-radius: 8px; padding: 12px; margin: 8px 16px 16px 16px; border: 1px dashed #667eea; }
    .location-edit-section .form-label { font-size: 12px; font-weight: 500; margin-bottom: 4px; }
    .location-edit-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="header">
    <h1><i class="bi bi-calendar-check"></i> To Do Schedule <span class="unsaved-indicator" id="unsavedIndicator">‚óè Unsaved changes</span></h1>
    <div>
      <button class="btn btn-success btn-sm me-2" onclick="saveAllChanges()">
        <i class="bi bi-check-lg"></i> Save
      </button>
      <button class="btn btn-outline-secondary btn-sm me-2" onclick="refreshData()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
      <button class="btn btn-primary btn-sm" onclick="closeDialog()">
        <i class="bi bi-x-lg"></i> Close
      </button>
    </div>
  </div>

  <ul class="nav nav-tabs mb-3" id="scheduleTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" type="button">
        <i class="bi bi-calendar3"></i> Calendar
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tasklist-tab" data-bs-toggle="tab" data-bs-target="#tasklist" type="button">
        <i class="bi bi-list-check"></i> Task List
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="mycheckllist-tab" data-bs-toggle="tab" data-bs-target="#mychecklist" type="button">
        <i class="bi bi-clipboard-check"></i> My Checklist <span class="badge bg-primary" id="checklistBadge" style="display: none;">0</span>
      </button>
    </li>
  </ul>

  <div class="tab-content" id="scheduleTabContent">
    <!-- Calendar Tab -->
    <div class="tab-pane fade show active" id="calendar" role="tabpanel">
      <div class="calendar-container">
        <div class="calendar-header">
          <button class="btn btn-outline-secondary btn-sm" onclick="changeMonth(-1)">
            <i class="bi bi-chevron-left"></i>
          </button>
          <span class="calendar-title" id="calendarTitle">January 2026</span>
          <button class="btn btn-outline-secondary btn-sm" onclick="changeMonth(1)">
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <!-- Calendar will be rendered here -->
        </div>
        <div class="mt-3 text-muted small">
          <span class="calendar-task-dot high"></span> High Priority
          <span class="calendar-task-dot medium ms-2"></span> Medium Priority
          <span class="calendar-task-dot low ms-2"></span> Low Priority
        </div>
      </div>
    </div>

    <!-- Task List Tab -->
    <div class="tab-pane fade" id="tasklist" role="tabpanel">
      <div class="filter-bar">
        <div class="row align-items-center">
          <div class="col-auto">
            <label class="form-label mb-0 me-2">Filter:</label>
          </div>
          <div class="col-auto">
            <select id="filterPriority" class="form-select form-select-sm" onchange="applyFilters()">
              <option value="">All Priorities</option>
              <option value="High">üî¥ High</option>
              <option value="Medium">üü° Medium</option>
              <option value="Low">üü¢ Low</option>
            </select>
          </div>
          <div class="col-auto">
            <select id="filterStatus" class="form-select form-select-sm" onchange="applyFilters()">
              <option value="">All Status</option>
              <option value="Pending">Pending</option>
              <option value="Complete">Complete</option>
              <option value="Scheduled">Scheduled</option>
              <option value="Overdue">Overdue</option>
            </select>
          </div>
          <div class="col-auto">
            <select id="filterSource" class="form-select form-select-sm" onchange="applyFilters()">
              <option value="">All Sources</option>
              <option value="Manual Tasks">Manual Tasks</option>
              <option value="Training Tracking">Training</option>
              <option value="Crew Visit Config">Crew Visits</option>
              <option value="Expiring Certs">Expiring Certs</option>
              <option value="Glove Swaps">Glove Swaps</option>
              <option value="Sleeve Swaps">Sleeve Swaps</option>
            </select>
          </div>
          <div class="col-auto">
            <input type="date" id="filterDate" class="form-control form-control-sm" onchange="applyFilters()">
          </div>
          <div class="col-auto">
            <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">Clear</button>
          </div>
        </div>
      </div>

      <div id="taskContainer">
        <div class="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading tasks...</p>
        </div>
      </div>
    </div>

    <!-- My Personal Checklist Tab -->
    <div class="tab-pane fade" id="mychecklist" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #34a853 0%, #1e8e3e 100%); color: white;">
          <div>
            <i class="bi bi-clipboard-check"></i> My Personal Checklist
            <span class="badge bg-white text-dark ms-2" id="checklistCount">0 items</span>
          </div>
          <button class="btn btn-light btn-sm" onclick="showAddManualItemModal()">
            <i class="bi bi-plus-lg"></i> Add Manual Item
          </button>
        </div>
        <div class="card-body" id="personalChecklistContainer">
          <div class="empty-state" id="emptyChecklist">
            <i class="bi bi-clipboard-plus" style="font-size: 48px; color: #5f6368;"></i>
            <p class="mt-3">No items in your checklist</p>
            <p class="text-muted">Add items from the Task List using <i class="bi bi-plus-circle"></i> or click "Add Manual Item" above</p>
          </div>
          <div id="checklistItems" style="display: none;">
            <!-- Checklist items will be rendered here -->
          </div>
        </div>
      </div>
      <div class="mt-3 text-muted small">
        <i class="bi bi-info-circle"></i> Manual items added here will also appear on the calendar view.
      </div>
    </div>
  </div>

  <!-- Day Detail Modal -->
  <div class="modal fade" id="dayDetailModal" tabindex="-1" aria-labelledby="dayDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <h5 class="modal-title" id="dayDetailModalLabel">üìÖ Day Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="dayDetailModalBody">
          <!-- Content will be populated dynamically -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Manual Item Modal -->
  <div class="modal fade" id="addManualItemModal" tabindex="-1" aria-labelledby="addManualItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #34a853 0%, #1e8e3e 100%); color: white;">
          <h5 class="modal-title" id="addManualItemModalLabel"><i class="bi bi-plus-circle"></i> Add Manual Scheduled Item</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Task Title *</label>
            <input type="text" class="form-control" id="manualTaskTitle" placeholder="e.g., Schedule 1st Aid Training">
          </div>
          <div class="mb-3">
            <label class="form-label">Description / Notes</label>
            <textarea class="form-control" id="manualTaskNotes" rows="2" placeholder="Optional notes or details"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Scheduled Date</label>
              <input type="date" class="form-control" id="manualTaskDate">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Location</label>
              <input type="text" class="form-control" id="manualTaskLocation" placeholder="e.g., Helena">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Start Time</label>
              <input type="time" class="form-control" id="manualTaskStartTime">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">End Time</label>
              <input type="time" class="form-control" id="manualTaskEndTime">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Priority</label>
            <select class="form-select" id="manualTaskPriority">
              <option value="Medium">Medium</option>
              <option value="High">High</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="manualTaskAddToCalendar" checked>
            <label class="form-check-label" for="manualTaskAddToCalendar">
              Also add to main Task List & Calendar
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="saveManualItem()">
            <i class="bi bi-check-lg"></i> Add Item
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    var allTasks = [];
    var currentMonth = new Date().getMonth();
    var currentYear = new Date().getFullYear();
    var monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
    var openLocationGroups = {}; // Track which location groups are open
    var personalChecklist = []; // Personal checklist for training items
    var hasUnsavedChanges = false;
    var pendingDateChanges = {}; // Track changes by task index

    // Helper: Format task type with item type (Glove/Sleeve) and item number
    function formatTaskType(task) {
      var taskType = task.taskType || 'Task';
      var itemType = task.itemType || '';
      var currentItem = task.currentItem || '';

      // Determine if it's a Glove or Sleeve based on itemType
      var itemLabel = '';
      if (itemType) {
        var itemTypeLower = itemType.toLowerCase();
        if (itemTypeLower.indexOf('glove') !== -1) {
          itemLabel = 'Glove';
        } else if (itemTypeLower.indexOf('sleeve') !== -1) {
          itemLabel = 'Sleeve';
        }
      }

      // Format based on task type
      if (taskType === 'Swap') {
        var swapLabel = itemLabel ? itemLabel + ' Swap' : 'Swap';
        if (currentItem) {
          swapLabel += ' (#' + currentItem + ')';
        }
        return swapLabel;
      } else if (taskType.indexOf('Reclaim') !== -1) {
        var reclaimLabel = itemLabel ? itemLabel + ' Reclaim' : 'Reclaim';
        if (currentItem) {
          reclaimLabel += ' (#' + currentItem + ')';
        }
        // Add class transition info if available
        if (taskType.indexOf('CL3‚ÜíCL2') !== -1) {
          reclaimLabel += ' (CL3‚ÜíCL2)';
        } else if (taskType.indexOf('CL2‚ÜíCL3') !== -1) {
          reclaimLabel += ' (CL2‚ÜíCL3)';
        }
        return reclaimLabel;
      } else if (taskType.indexOf('Training') !== -1) {
        // Show training topic if available
        if (itemType && itemType !== 'Training') {
          return 'Training: ' + itemType;
        }
        return taskType;
      } else if (taskType === 'Cert Expiring' || taskType.indexOf('Renew') !== -1) {
        // Show cert type if available
        if (itemType) {
          return 'Renew ' + itemType;
        }
        return taskType;
      }

      return taskType;
    }

    // Helper: Extract foreman from location string (handles "Location (üë∑ Foreman)" format)
    function extractForemanFromLocation(loc) {
      if (!loc) return null;
      var match = loc.match(/\(([^)]+)\)$/);
      if (match) {
        var foreman = match[1].trim();
        // Remove emoji prefix if present (üë∑)
        if (foreman.indexOf('üë∑') !== -1) {
          foreman = foreman.replace('üë∑', '').trim();
        }
        return foreman;
      }
      return null;
    }

    // Helper: Get the group name (foreman/supervisor) for a task
    // Groups all crew members under their foreman/supervisor (F, GTO F, GF, SUP classifications)
    function getTaskGroupName(task) {
      var loc = task.location || '';

      // FIRST: Always try to extract foreman from location (this groups all crew members under their foreman)
      var foremanFromLocation = extractForemanFromLocation(loc);
      if (foremanFromLocation) {
        return foremanFromLocation;
      }

      // For Training and Cert tasks, use the employee name (crew lead) as the foreman
      var taskType = (task.taskType || '').toLowerCase();
      if (taskType.indexOf('training') !== -1 || taskType.indexOf('cert') !== -1) {
        if (task.employee && task.employee.trim()) {
          var empName = task.employee.trim();
          var parenIndex = empName.indexOf(' (');
          if (parenIndex !== -1) {
            return empName.substring(0, parenIndex);
          }
          return empName;
        }
      }

      // Fall back to employee name if available
      if (task.employee && task.employee.trim()) {
        var empName = task.employee.trim();
        var parenIndex = empName.indexOf(' (');
        if (parenIndex !== -1) {
          return empName.substring(0, parenIndex);
        }
        return empName;
      }

      return 'Unassigned';
    }

    // Helper: Get the task category for sub-grouping under foreman
    // Categories: Training, Rubber Changes (swaps/reclaims), Expiring Certs, Other
    function getTaskCategory(task) {
      var taskType = (task.taskType || '').toLowerCase();
      var source = (task.source || '').toLowerCase();

      // Training tasks - from Training Tracking source OR has "training" in taskType
      // This includes "Renew Harassment Training", "Training: Topic", etc.
      if (source.indexOf('training tracking') !== -1 ||
          taskType.indexOf('training') !== -1) {
        return 'Training';
      }

      // Rubber Changes (Swaps and Reclaims)
      if (taskType.indexOf('swap') !== -1 || taskType.indexOf('reclaim') !== -1 ||
          source.indexOf('swap') !== -1 || source.indexOf('reclaim') !== -1) {
        return 'Rubber Changes';
      }

      // Expiring Certs - certification renewals (NOT training)
      // Includes: "Renew 1st Aid", "Renew CPR", "Renew Crane Cert", "Cert Expiring", etc.
      // Check for cert-related keywords in taskType
      var certKeywords = ['cert', 'expir', '1st aid', 'first aid', 'cpr', 'crane', 'cdl', 'mec', 'dl'];
      var isCertTask = false;
      for (var i = 0; i < certKeywords.length; i++) {
        if (taskType.indexOf(certKeywords[i]) !== -1) {
          isCertTask = true;
          break;
        }
      }
      // Also check source
      if (source.indexOf('cert') !== -1 || source.indexOf('expir') !== -1) {
        isCertTask = true;
      }
      // "Renew X" where X is not training-related is a cert
      if (taskType.indexOf('renew') !== -1 && taskType.indexOf('training') === -1) {
        isCertTask = true;
      }

      if (isCertTask) {
        return 'Expiring Certs';
      }

      // Everything else goes to Other
      return 'Other';
    }

    // Category display order and icons
    var categoryOrder = ['Training', 'Rubber Changes', 'Expiring Certs', 'Other'];
    var categoryIcons = {
      'Training': 'bi-mortarboard',
      'Rubber Changes': 'bi-arrow-left-right',
      'Expiring Certs': 'bi-file-earmark-medical',
      'Other': 'bi-three-dots'
    };
    var categoryColors = {
      'Training': '#1a73e8',
      'Rubber Changes': '#34a853',
      'Expiring Certs': '#ea4335',
      'Other': '#5f6368'
    };

    function setUnsaved(value) {
      hasUnsavedChanges = value;
      var indicator = document.getElementById('unsavedIndicator');
      if (value) {
        indicator.classList.add('show');
      } else {
        indicator.classList.remove('show');
      }
    }

    function closeDialog() {
      if (hasUnsavedChanges) {
        alert('You have unsaved changes. Please click Save before closing, or click Refresh to discard changes.');
        return; // Don't allow closing
      }
      google.script.host.close();
    }

    function saveAllChanges() {
      var changes = Object.keys(pendingDateChanges).map(function(key) {
        return pendingDateChanges[key];
      });

      if (changes.length === 0) {
        showToast('No changes to save');
        return;
      }

      showToast('Saving ' + changes.length + ' change(s)...');

      google.script.run
        .withSuccessHandler(function(result) {
          pendingDateChanges = {};
          setUnsaved(false);
          // Remove changed styling from inputs
          var inputs = document.querySelectorAll('.date-input.changed');
          inputs.forEach(function(input) { input.classList.remove('changed'); });
          showToast('‚úì Saved ' + changes.length + ' change(s) successfully!');
        })
        .withFailureHandler(function(error) {
          showToast('Error saving: ' + error, 'error');
        })
        .saveScheduleTaskDateChanges(changes);
    }

    function loadTasks() {
      google.script.run
        .withSuccessHandler(function(tasks) {
          allTasks = tasks || [];
          renderTasks(allTasks);
          renderCalendar();
          renderPersonalChecklist();
        })
        .withFailureHandler(function(error) {
          document.getElementById('taskContainer').innerHTML =
            '<div class="alert alert-danger">Error loading tasks: ' + error + '</div>';
        })
        .getScheduleTasks();
    }

    // ================== CALENDAR FUNCTIONS ==================
    function renderCalendar() {
      var grid = document.getElementById('calendarGrid');
      var title = document.getElementById('calendarTitle');
      title.textContent = monthNames[currentMonth] + ' ' + currentYear;

      var firstDay = new Date(currentYear, currentMonth, 1);
      var lastDay = new Date(currentYear, currentMonth + 1, 0);
      var startDay = firstDay.getDay();
      var daysInMonth = lastDay.getDate();

      var today = new Date();
      var todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

      // Group tasks by date
      var tasksByDate = {};
      allTasks.forEach(function(task) {
        if (task.scheduledDate) {
          if (!tasksByDate[task.scheduledDate]) tasksByDate[task.scheduledDate] = [];
          tasksByDate[task.scheduledDate].push(task);
        }
      });

      var html = '';

      // Day headers
      var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayNames.forEach(function(day) {
        html += '<div class="calendar-day-header">' + day + '</div>';
      });

      // Days from previous month
      var prevMonth = new Date(currentYear, currentMonth, 0);
      var prevMonthDays = prevMonth.getDate();
      for (var i = startDay - 1; i >= 0; i--) {
        var dayNum = prevMonthDays - i;
        html += '<div class="calendar-day other-month"><div class="calendar-day-number">' + dayNum + '</div></div>';
      }

      // Days in current month
      for (var day = 1; day <= daysInMonth; day++) {
        var dateStr = currentYear + '-' + String(currentMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        var dayTasks = tasksByDate[dateStr] || [];
        var isToday = dateStr === todayStr;
        var hasTasks = dayTasks.length > 0;

        var classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (hasTasks) classes += ' has-tasks';

        html += '<div class="' + classes + '" onclick="showDayDetail(\'' + dateStr + '\', event)">';
        html += '<div class="calendar-day-number">' + day + '</div>';

        if (hasTasks) {
          // Show priority dots
          var highCount = dayTasks.filter(function(t) { return t.priority === 'High'; }).length;
          var medCount = dayTasks.filter(function(t) { return t.priority === 'Medium'; }).length;
          var lowCount = dayTasks.filter(function(t) { return t.priority === 'Low'; }).length;

          html += '<div>';
          for (var h = 0; h < Math.min(highCount, 3); h++) html += '<span class="calendar-task-dot high"></span>';
          for (var m = 0; m < Math.min(medCount, 3); m++) html += '<span class="calendar-task-dot medium"></span>';
          for (var l = 0; l < Math.min(lowCount, 3); l++) html += '<span class="calendar-task-dot low"></span>';
          html += '</div>';

          // Group tasks by location and count
          var locationCounts = {};
          dayTasks.forEach(function(t) {
            var loc = t.location || 'No Location';
            if (!locationCounts[loc]) locationCounts[loc] = 0;
            locationCounts[loc]++;
          });

          // Sort locations by task count (most tasks first)
          var sortedLocations = Object.keys(locationCounts).sort(function(a, b) {
            return locationCounts[b] - locationCounts[a];
          });

          // Show first 2 locations with counts
          for (var loc = 0; loc < Math.min(sortedLocations.length, 2); loc++) {
            var locName = sortedLocations[loc];
            var count = locationCounts[locName];
            html += '<div class="calendar-task-location">üìç ' + locName;
            if (count > 1) html += ' (' + count + ')';
            html += '</div>';
          }
          if (sortedLocations.length > 2) {
            html += '<div class="calendar-task-preview">+' + (sortedLocations.length - 2) + ' more</div>';
          }
        }
        html += '</div>';
      }

      // Days from next month
      var totalCells = startDay + daysInMonth;
      var remainingCells = 7 - (totalCells % 7);
      if (remainingCells < 7) {
        for (var n = 1; n <= remainingCells; n++) {
          html += '<div class="calendar-day other-month"><div class="calendar-day-number">' + n + '</div></div>';
        }
      }

      grid.innerHTML = html;
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar();
    }

    function showDayDetail(dateStr, event) {
      event.stopPropagation();

      var dayTasks = allTasks.filter(function(t) { return t.scheduledDate === dateStr; });

      var date = new Date(dateStr + 'T12:00:00');
      var dateDisplay = monthNames[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();

      // Update modal title
      document.getElementById('dayDetailModalLabel').innerHTML = 'üìÖ ' + dateDisplay + ' <span class="badge bg-light text-dark ms-2">' + dayTasks.length + ' task(s)</span>';

      var modalBody = document.getElementById('dayDetailModalBody');

      if (dayTasks.length === 0) {
        modalBody.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-calendar-x" style="font-size: 48px;"></i><p class="mt-3">No tasks scheduled for this day.</p></div>';
      } else {
        // Group tasks by location
        var tasksByLoc = {};
        dayTasks.forEach(function(task) {
          var loc = task.location || 'No Location';
          if (!tasksByLoc[loc]) tasksByLoc[loc] = [];
          tasksByLoc[loc].push(task);
        });

        var html = '';

        // Render by location
        var locations = Object.keys(tasksByLoc).sort();
        locations.forEach(function(location) {
          var locTasks = tasksByLoc[location];
          html += '<div class="mb-4">';
          html += '<h6 style="color: #667eea; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px;"><i class="bi bi-geo-alt-fill"></i> ' + location + ' <span class="badge bg-secondary">' + locTasks.length + '</span></h6>';

          locTasks.forEach(function(task) {
            var priorityClass = 'priority-' + (task.priority || 'medium').toLowerCase();
            var statusClass = getStatusClass(task.status);
            var displayTaskType = formatTaskType(task);

            html += '<div class="day-detail-task ' + priorityClass + ' mb-2">';
            html += '<div class="d-flex justify-content-between align-items-start">';
            html += '<div><strong>' + displayTaskType + '</strong>';
            if (task.employee) html += '<div class="text-muted small">üë§ ' + task.employee + '</div>';
            html += '</div>';
            html += '<span class="status-badge ' + statusClass + '">' + (task.status || 'Pending') + '</span>';
            html += '</div>';

            html += '<div class="small text-muted mt-1">';
            html += '<i class="bi bi-box-arrow-in-right"></i> ' + (task.source || 'Unknown');
            if (task.startTime) {
              html += ' &nbsp;|&nbsp; <i class="bi bi-clock"></i> ' + task.startTime;
              if (task.endTime) html += ' - ' + task.endTime;
            }
            html += '</div>';

            if (task.notes) {
              html += '<div class="text-muted small mt-1 fst-italic"><i class="bi bi-info-circle"></i> ' + task.notes + '</div>';
            }
            html += '</div>';
          });

          html += '</div>';
        });

        modalBody.innerHTML = html;
      }

      // Show the modal
      var modal = new bootstrap.Modal(document.getElementById('dayDetailModal'));
      modal.show();
    }

    function closeDayDetail() {
      var modal = bootstrap.Modal.getInstance(document.getElementById('dayDetailModal'));
      if (modal) modal.hide();
    }

    // ================== TASK LIST FUNCTIONS ==================
    function renderTasks(tasks) {
      var container = document.getElementById('taskContainer');

      if (!tasks || tasks.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x" style="font-size: 48px;"></i><p class="mt-3">No tasks found</p><p class="text-muted">Tasks will appear from Manual Tasks, Training, Crew Visits, Expiring Certs, and Swaps</p></div>';
        return;
      }

      // Filter out tasks that have been added to personal checklist (1st Aid/CPR items)
      var filteredTasks = tasks.filter(function(task, index) {
        task._originalIndex = index; // Preserve original index for actions
        return !isTaskInChecklist(task);
      });

      if (filteredTasks.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-check" style="font-size: 48px;"></i><p class="mt-3">All tasks handled</p><p class="text-muted">Some tasks may have been moved to your personal checklist</p></div>';
        return;
      }

      // Extract base location from location string (remove foreman parentheses)
      function parseLocation(locString) {
        var loc = locString || 'No Location';
        var match = loc.match(/^([^(]+)\s*\(([^)]+)\)$/);
        if (match) {
          return { baseLocation: match[1].trim(), foreman: match[2].trim() };
        }
        return { baseLocation: loc.trim(), foreman: '' };
      }

      // Group tasks: Location > Foreman > Category
      var tasksByBaseLocation = {};
      filteredTasks.forEach(function(task) {
        var parsed = parseLocation(task.location);
        var baseLoc = parsed.baseLocation;
        var groupName = getTaskGroupName(task);
        var category = getTaskCategory(task);

        if (!tasksByBaseLocation[baseLoc]) {
          tasksByBaseLocation[baseLoc] = {};
        }
        if (!tasksByBaseLocation[baseLoc][groupName]) {
          tasksByBaseLocation[baseLoc][groupName] = {};
        }
        if (!tasksByBaseLocation[baseLoc][groupName][category]) {
          tasksByBaseLocation[baseLoc][groupName][category] = [];
        }
        tasksByBaseLocation[baseLoc][groupName][category].push(task);
      });

      // Sort base locations alphabetically
      var baseLocations = Object.keys(tasksByBaseLocation).sort();

      var html = '';

      baseLocations.forEach(function(baseLocation, locIndex) {
        var foremanGroups = tasksByBaseLocation[baseLocation];
        var foremen = Object.keys(foremanGroups).sort(function(a, b) {
          if (a === 'Unassigned') return 1;
          if (b === 'Unassigned') return -1;
          return a.localeCompare(b);
        });

        // Count totals for this location
        var totalTasks = 0;
        var highCount = 0, medCount = 0, lowCount = 0;
        foremen.forEach(function(f) {
          var categories = foremanGroups[f];
          Object.keys(categories).forEach(function(cat) {
            categories[cat].forEach(function(t) {
              totalTasks++;
              if (t.priority === 'High') highCount++;
              else if (t.priority === 'Medium') medCount++;
              else lowCount++;
            });
          });
        });

        html += '<div class="card mb-2">';
        html += '<div class="card-header location-header" style="cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">';
        html += '<div class="d-flex justify-content-between align-items-center">';
        var isOpen = openLocationGroups[locIndex] === true;
        html += '<div onclick="toggleLocationGroup(' + locIndex + ')" style="flex: 1;"><i class="bi ' + (isOpen ? 'bi-chevron-down' : 'bi-chevron-right') + ' me-2" id="loc-chevron-' + locIndex + '"></i>';
        html += '<i class="bi bi-geo-alt me-1"></i><strong>' + baseLocation + '</strong>';
        html += '<span class="badge bg-white text-dark ms-2" style="opacity: 0.9;">' + totalTasks + ' tasks</span></div>';
        html += '<div class="d-flex align-items-center">';
        html += '<button class="btn btn-sm btn-light bulk-edit-btn me-2" onclick="event.stopPropagation(); toggleLocationEdit(' + locIndex + ', \'' + escapeHtml(baseLocation) + '\')" title="Edit all tasks for this location"><i class="bi bi-pencil-square"></i> Bulk Edit</button>';
        if (highCount > 0) html += '<span class="badge me-1" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">' + highCount + ' High</span>';
        if (medCount > 0) html += '<span class="badge me-1" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">' + medCount + ' Med</span>';
        if (lowCount > 0) html += '<span class="badge" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">' + lowCount + ' Low</span>';
        html += '</div></div></div>';

        // Location body - respect saved open/closed state
        html += '<div class="card-body p-0 location-body" id="loc-body-' + locIndex + '" style="display: ' + (isOpen ? 'block' : 'none') + ';">';

        // Bulk Edit Section (hidden by default)
        html += '<div class="location-edit-section" id="loc-edit-' + locIndex + '" style="display: none;">';
        html += '<div class="d-flex justify-content-between align-items-center mb-2">';
        html += '<strong><i class="bi bi-pencil-square text-primary"></i> Bulk Edit: ' + baseLocation + '</strong>';
        html += '<button class="btn btn-sm btn-outline-secondary" onclick="toggleLocationEdit(' + locIndex + ')"><i class="bi bi-x"></i></button>';
        html += '</div>';
        html += '<div class="location-edit-row">';
        html += '<div><label class="form-label">Set Date for All</label><input type="date" class="form-control form-control-sm" id="bulk-date-' + locIndex + '" style="width: 140px;"></div>';
        html += '<div><label class="form-label">Start Time</label><input type="time" class="form-control form-control-sm" id="bulk-start-' + locIndex + '" style="width: 110px;"></div>';
        html += '<div><label class="form-label">End Time</label><input type="time" class="form-control form-control-sm" id="bulk-end-' + locIndex + '" style="width: 110px;"></div>';
        html += '<div class="d-flex align-items-end"><button class="btn btn-primary btn-sm" onclick="applyBulkEdit(' + locIndex + ', \'' + escapeHtml(baseLocation) + '\')"><i class="bi bi-check-lg"></i> Apply to All</button></div>';
        html += '</div>';
        html += '<div class="text-muted small mt-2"><i class="bi bi-info-circle"></i> This will update the date and time for all ' + totalTasks + ' tasks at this location.</div>';
        html += '</div>';

        // Render each foreman group
        foremen.forEach(function(foreman, foremanIndex) {
          var categoryGroups = foremanGroups[foreman];

          // Count total tasks for this foreman
          var foremanTaskCount = 0;
          Object.keys(categoryGroups).forEach(function(cat) {
            foremanTaskCount += categoryGroups[cat].length;
          });

          // Show foreman sub-header
          if (foremen.length > 1 || foreman !== 'Unassigned') {
            html += '<div class="foreman-header" style="background: #e8eaed; padding: 10px 16px; border-bottom: 1px solid #dadce0;">';
            html += '<i class="bi bi-person-badge me-2" style="color: #667eea;"></i>';
            html += '<strong>' + foreman + '</strong>';
            html += '<span class="badge bg-secondary ms-2">' + foremanTaskCount + ' task(s)</span>';
            html += '</div>';
          }

          // Table headers
          html += '<div class="task-row bg-light" style="font-weight: 600; font-size: 12px; padding: 8px 12px;">';
          html += '<div class="row align-items-center">';
          html += '<div class="col-md-3">Task / Source</div>';
          html += '<div class="col-md-2">Scheduled Date</div>';
          html += '<div class="col-md-2">Start / End Time</div>';
          html += '<div class="col-md-2">Status</div>';
          html += '<div class="col-md-3 text-end">Actions</div>';
          html += '</div></div>';

          // Render each category in order: Training, Rubber Changes, Expiring Certs, Other
          categoryOrder.forEach(function(category) {
            var categoryTasks = categoryGroups[category];
            if (!categoryTasks || categoryTasks.length === 0) return;

            // Sort tasks by employee name within category
            categoryTasks.sort(function(a, b) {
              var empA = (a.employee || '').toLowerCase();
              var empB = (b.employee || '').toLowerCase();
              return empA.localeCompare(empB);
            });

            // Category sub-header
            var icon = categoryIcons[category] || 'bi-list';
            var color = categoryColors[category] || '#5f6368';
            html += '<div class="category-subheader" style="background: #f8f9fa; padding: 6px 16px; border-bottom: 1px solid #dadce0; font-size: 12px; margin-left: 20px;">';
            html += '<i class="bi ' + icon + ' me-1" style="color: ' + color + ';"></i>';
            html += '<strong>' + category + '</strong>';
            html += '<span class="badge ms-2" style="background: ' + color + '; color: white;">' + categoryTasks.length + '</span>';
            html += '</div>';

            categoryTasks.forEach(function(task) {
              html += renderTaskRow(task);
            });
          });
        });

        html += '</div></div>'; // location-body and card
      });

      container.innerHTML = html;
    }

    // Helper function to render a single task row
    function renderTaskRow(task) {
      var priorityClass = 'priority-' + (task.priority || 'medium').toLowerCase();
      var statusClass = getStatusClass(task.status);
      var displayTaskType = formatTaskType(task);
      var html = '';

      html += '<div class="task-row ' + priorityClass + '">';
      html += '<div class="row align-items-center">';

      // Task Type & Source
      html += '<div class="col-md-3">';
      html += '<div class="task-type" style="font-weight: 500;">' + displayTaskType + '</div>';
      html += '<div class="task-source"><i class="bi bi-box-arrow-in-right"></i> ' + (task.source || 'Unknown') + '</div>';
      if (task.employee) html += '<div class="text-muted small"><i class="bi bi-person"></i> ' + task.employee + '</div>';
      html += '</div>';

      // Scheduled Date (editable)
      html += '<div class="col-md-2">';
      html += '<input type="date" class="date-input" value="' + (task.scheduledDate || '') + '" onchange="updateTaskDate(' + task._originalIndex + ', this.value, this)">';
      html += '</div>';

      // Time (editable start and end)
      html += '<div class="col-md-2">';
      html += '<div class="d-flex gap-1 align-items-center">';
      html += '<input type="time" class="time-input" value="' + (task.startTime || '') + '" onchange="updateTaskTime(' + task._originalIndex + ', \'start\', this.value, this)" placeholder="Start">';
      html += '<span class="text-muted">-</span>';
      html += '<input type="time" class="time-input" value="' + (task.endTime || '') + '" onchange="updateTaskTime(' + task._originalIndex + ', \'end\', this.value, this)" placeholder="End">';
      html += '</div>';
      html += '</div>';

      // Status
      html += '<div class="col-md-2">';
      html += '<span class="status-badge ' + statusClass + '">' + (task.status || 'Pending') + '</span>';
      html += '</div>';

      // Actions
      html += '<div class="col-md-3 text-end">';

      // Add to checklist button for 1st Aid and CPR tasks
      var taskTypeLower = (task.taskType || '').toLowerCase();
      var itemTypeLower = (task.itemType || '').toLowerCase();
      var isTrainingCert = taskTypeLower.indexOf('1st aid') !== -1 ||
                           taskTypeLower.indexOf('first aid') !== -1 ||
                           taskTypeLower.indexOf('cpr') !== -1 ||
                           itemTypeLower.indexOf('1st aid') !== -1 ||
                           itemTypeLower.indexOf('first aid') !== -1 ||
                           itemTypeLower.indexOf('cpr') !== -1;

      if (isTrainingCert) {
        html += '<button class="btn btn-outline-primary btn-sm me-1" onclick="event.stopPropagation(); addToChecklist(' + task._originalIndex + ')" title="Add to My Checklist"><i class="bi bi-plus-circle"></i></button>';
      }

      html += '<button class="btn btn-outline-success btn-sm me-1" onclick="event.stopPropagation(); markComplete(' + task._originalIndex + ')" title="Mark Complete"><i class="bi bi-check-lg"></i></button>';
      if (task.source === 'Manual Tasks') {
        html += '<button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteTask(' + task._originalIndex + ')" title="Delete"><i class="bi bi-trash"></i></button>';
      }
      html += '</div>';

      html += '</div>'; // row

      // Notes row
      if (task.notes) {
        html += '<div class="text-muted small mt-1"><i class="bi bi-info-circle"></i> ' + task.notes + '</div>';
      }

      html += '</div>'; // task-row
      return html;
    }

    function getStatusClass(status) {
      var statusLower = (status || 'pending').toLowerCase();
      if (statusLower.indexOf('complete') !== -1) return 'status-complete';
      if (statusLower.indexOf('overdue') !== -1) return 'status-overdue';
      if (statusLower.indexOf('scheduled') !== -1) return 'status-scheduled';
      return 'status-pending';
    }

    function toggleLocationGroup(locIndex) {
      var body = document.getElementById('loc-body-' + locIndex);
      var chevron = document.getElementById('loc-chevron-' + locIndex);
      if (body.style.display === 'none') {
        body.style.display = 'block';
        chevron.className = 'bi bi-chevron-down me-2';
        openLocationGroups[locIndex] = true;
      } else {
        body.style.display = 'none';
        chevron.className = 'bi bi-chevron-right me-2';
        openLocationGroups[locIndex] = false;
      }
    }


    function updateTaskDate(index, newDate, inputElement) {
      // Update local data immediately
      var task = allTasks[index];
      var oldDate = task.scheduledDate;
      task.scheduledDate = newDate;

      // Track the change for batch saving
      if (!pendingDateChanges[index]) {
        pendingDateChanges[index] = { index: index, task: task };
      }
      pendingDateChanges[index].oldDate = oldDate;
      pendingDateChanges[index].newDate = newDate;

      // Mark input as changed
      if (inputElement) {
        inputElement.classList.add('changed');
      }

      // Update calendar view immediately
      renderCalendar();

      // Show unsaved indicator
      setUnsaved(true);
      showToast('Date changed - click Save to apply');
    }

    function updateTaskTime(index, timeType, newTime, inputElement) {
      // Update local data immediately
      var task = allTasks[index];

      if (timeType === 'start') {
        task.startTime = newTime;
      } else {
        task.endTime = newTime;
      }

      // Track the change for batch saving
      if (!pendingDateChanges[index]) {
        pendingDateChanges[index] = { index: index, task: task };
      }
      pendingDateChanges[index].startTime = task.startTime;
      pendingDateChanges[index].endTime = task.endTime;

      // Mark input as changed
      if (inputElement) {
        inputElement.classList.add('changed');
      }

      // Show unsaved indicator
      setUnsaved(true);
      showToast('Time changed - click Save to apply');
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    function toggleLocationEdit(locIndex, locationName) {
      var editSection = document.getElementById('loc-edit-' + locIndex);
      var body = document.getElementById('loc-body-' + locIndex);

      // Make sure location is expanded
      if (body.style.display === 'none') {
        body.style.display = 'block';
        var chevron = document.getElementById('loc-chevron-' + locIndex);
        if (chevron) chevron.className = 'bi bi-chevron-down me-2';
        openLocationGroups[locIndex] = true;
      }

      if (editSection.style.display === 'none') {
        editSection.style.display = 'block';
      } else {
        editSection.style.display = 'none';
      }
    }

    function applyBulkEdit(locIndex, locationName) {
      var dateInput = document.getElementById('bulk-date-' + locIndex);
      var startInput = document.getElementById('bulk-start-' + locIndex);
      var endInput = document.getElementById('bulk-end-' + locIndex);

      var newDate = dateInput ? dateInput.value : '';
      var newStart = startInput ? startInput.value : '';
      var newEnd = endInput ? endInput.value : '';

      if (!newDate && !newStart && !newEnd) {
        showToast('Please enter at least one value to apply', 'error');
        return;
      }

      var updatedCount = 0;

      // Find all tasks at this location and update them
      allTasks.forEach(function(task, index) {
        // Parse location to get base location
        var taskLoc = task.location || '';
        var match = taskLoc.match(/^([^(]+)/);
        var baseTaskLoc = match ? match[1].trim() : taskLoc.trim();

        if (baseTaskLoc === locationName) {
          // Update task
          if (newDate) {
            task.scheduledDate = newDate;
          }
          if (newStart) {
            task.startTime = newStart;
          }
          if (newEnd) {
            task.endTime = newEnd;
          }

          // Track for saving
          if (!pendingDateChanges[index]) {
            pendingDateChanges[index] = { index: index, task: task };
          }
          pendingDateChanges[index].newDate = task.scheduledDate;
          pendingDateChanges[index].startTime = task.startTime;
          pendingDateChanges[index].endTime = task.endTime;

          updatedCount++;
        }
      });

      if (updatedCount > 0) {
        setUnsaved(true);
        renderTasks(allTasks);
        renderCalendar();
        showToast('Updated ' + updatedCount + ' task(s) - click Save to apply');

        // Clear bulk edit inputs
        if (dateInput) dateInput.value = '';
        if (startInput) startInput.value = '';
        if (endInput) endInput.value = '';
      } else {
        showToast('No tasks found for this location', 'error');
      }
    }

    function markComplete(index) {
      var task = allTasks[index];

      // Check if this is a cert renewal task
      if (task.taskType && task.taskType.toLowerCase().indexOf('renew') !== -1) {
        // Extract cert type and employee from task
        var certType = task.taskType.replace(/renew\s*/i, '').trim();
        var employee = task.notes ? extractEmployeeFromNotes(task.notes) : task.employee || '';

        if (employee && certType) {
          showCertExpirationModal(employee, certType, index);
          return;
        }
      }

      // Regular task completion
      google.script.run
        .withSuccessHandler(function() {
          allTasks[index].status = 'Complete';
          renderTasks(allTasks);
          renderCalendar();
          showToast('Task marked complete');
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error, 'error');
        })
        .markScheduleTaskComplete(allTasks[index]);
    }

    function extractEmployeeFromNotes(notes) {
      // Extract employee name from notes like "Employee: John Smith | ..."
      var match = notes.match(/Employee:\s*([^|]+)/i);
      return match ? match[1].trim() : '';
    }

    function showCertExpirationModal(employee, certType, taskIndex) {
      // Calculate default expiration based on cert type
      var today = new Date();
      var defaultYears = 1;

      if (certType.toLowerCase().indexOf('dl') !== -1 || certType.toLowerCase().indexOf('driver') !== -1) {
        defaultYears = 2;
      } else if (certType.toLowerCase().indexOf('mec') !== -1 || certType.toLowerCase().indexOf('medical') !== -1) {
        defaultYears = 3;
      }

      var defaultDate = new Date(today.getFullYear() + defaultYears, today.getMonth(), today.getDate());
      var defaultDateStr = defaultDate.toISOString().split('T')[0];

      var modalHtml = '<div class="modal fade" id="certExpirationModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">';
      modalHtml += '<div class="modal-header"><h5 class="modal-title">üìÖ Update Certification Expiration</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>';
      modalHtml += '<div class="modal-body">';
      modalHtml += '<p><strong>Employee:</strong> ' + employee + '</p>';
      modalHtml += '<p><strong>Certification:</strong> ' + certType + '</p>';
      modalHtml += '<div class="mb-3"><label class="form-label">New Expiration Date *</label>';
      modalHtml += '<input type="date" class="form-control" id="newCertExpiration" value="' + defaultDateStr + '" required></div>';
      modalHtml += '<p class="text-muted small">This will update the expiration date in the Expiring Certs sheet.</p>';
      modalHtml += '</div><div class="modal-footer">';
      modalHtml += '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>';
      modalHtml += '<button type="button" class="btn btn-success" onclick="saveCertExpiration(\'' + employee + '\', \'' + certType + '\', ' + taskIndex + ')">Save & Complete Task</button>';
      modalHtml += '</div></div></div></div>';

      var existingModal = document.getElementById('certExpirationModal');
      if (existingModal) existingModal.remove();

      document.body.insertAdjacentHTML('beforeend', modalHtml);
      var modal = new bootstrap.Modal(document.getElementById('certExpirationModal'));
      modal.show();
    }

    function saveCertExpiration(employee, certType, taskIndex) {
      var newExpiration = document.getElementById('newCertExpiration').value;

      if (!newExpiration) {
        alert('Please enter an expiration date');
        return;
      }

      // Close modal
      var modal = bootstrap.Modal.getInstance(document.getElementById('certExpirationModal'));
      modal.hide();

      // Update cert and mark task complete
      google.script.run
        .withSuccessHandler(function(result) {
          allTasks[taskIndex].status = 'Complete';
          renderTasks(allTasks);
          renderCalendar();
          showToast('‚úì Certification updated and task completed!');
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error, 'error');
        })
        .updateCertExpirationFromTask(employee, certType, newExpiration, allTasks[taskIndex]);
    }

    function deleteTask(index) {
      if (!confirm('Are you sure you want to delete this task?')) return;

      google.script.run
        .withSuccessHandler(function() {
          allTasks.splice(index, 1);
          renderTasks(allTasks);
          renderCalendar();
          showToast('Task deleted');
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error, 'error');
        })
        .deleteScheduleTask(index);
    }

    function applyFilters() {
      var priority = document.getElementById('filterPriority').value;
      var status = document.getElementById('filterStatus').value;
      var source = document.getElementById('filterSource').value;
      var date = document.getElementById('filterDate').value;

      var filtered = allTasks.filter(function(task) {
        if (priority && task.priority !== priority) return false;
        if (status && task.status !== status) return false;
        if (source && task.source !== source) return false;
        if (date && task.scheduledDate !== date) return false;
        return true;
      });

      renderTasks(filtered);
    }

    function clearFilters() {
      document.getElementById('filterPriority').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterSource').value = '';
      document.getElementById('filterDate').value = '';
      renderTasks(allTasks);
    }

    function refreshData() {
      document.getElementById('taskContainer').innerHTML = '<div class="loading"><div class="spinner-border text-primary"></div><p class="mt-3">Refreshing...</p></div>';
      loadTasks();
    }

    function showToast(message, type) {
      var toast = document.createElement('div');
      toast.className = 'alert alert-' + (type === 'error' ? 'danger' : 'success') + ' position-fixed';
      toast.style.cssText = 'bottom: 20px; right: 20px; z-index: 9999; animation: fadeIn 0.3s;';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(function() { toast.remove(); }, 3000);
    }

    // ================== PERSONAL CHECKLIST FUNCTIONS ==================
    function isTaskInChecklist(task) {
      return personalChecklist.some(function(item) {
        return item.employee === task.employee &&
               item.taskType === task.taskType &&
               item.itemType === task.itemType;
      });
    }

    function addToChecklist(index) {
      var task = allTasks[index];
      if (!isTaskInChecklist(task)) {
        var checklistItem = {
          id: Date.now(),
          employee: task.employee || '',
          taskType: task.taskType || '',
          itemType: task.itemType || '',
          location: task.location || '',
          scheduledDate: task.scheduledDate || '',
          source: task.source || '',
          subject: 'Add to upcoming training',
          addedDate: new Date().toISOString().split('T')[0],
          completed: false
        };
        personalChecklist.push(checklistItem);
        saveChecklistToStorage();
        updateChecklistBadge();
        renderPersonalChecklist();
        renderTasks(allTasks); // Re-render to remove from foreman's list
        showToast('‚úì Moved to your personal checklist');
      }
    }

    function removeFromChecklist(index) {
      var task = allTasks[index];
      personalChecklist = personalChecklist.filter(function(item) {
        return !(item.employee === task.employee &&
                 item.taskType === task.taskType &&
                 item.itemType === task.itemType);
      });
      saveChecklistToStorage();
      updateChecklistBadge();
      renderPersonalChecklist();
      renderTasks(allTasks); // Re-render to show back in foreman's list
      showToast('Returned to foreman\'s checklist');
    }

    function removeChecklistItemById(id) {
      personalChecklist = personalChecklist.filter(function(item) {
        return item.id !== id;
      });
      saveChecklistToStorage();
      updateChecklistBadge();
      renderPersonalChecklist();
      renderTasks(allTasks); // Re-render to show back in foreman's list
      showToast('Returned to foreman\'s checklist');
    }

    function toggleChecklistItemComplete(id) {
      personalChecklist.forEach(function(item) {
        if (item.id === id) {
          item.completed = !item.completed;
        }
      });
      saveChecklistToStorage();
      renderPersonalChecklist();
    }

    function saveChecklistToStorage() {
      try {
        localStorage.setItem('rubberTracker_personalChecklist', JSON.stringify(personalChecklist));
      } catch (e) {
        console.log('Could not save to localStorage:', e);
      }
    }

    function loadChecklistFromStorage() {
      try {
        var stored = localStorage.getItem('rubberTracker_personalChecklist');
        if (stored) {
          personalChecklist = JSON.parse(stored);
        }
      } catch (e) {
        console.log('Could not load from localStorage:', e);
        personalChecklist = [];
      }
      updateChecklistBadge();
    }

    function updateChecklistBadge() {
      var badge = document.getElementById('checklistBadge');
      var countSpan = document.getElementById('checklistCount');
      var count = personalChecklist.length;

      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
      }

      if (countSpan) {
        countSpan.textContent = count + ' item' + (count !== 1 ? 's' : '');
      }
    }

    function renderPersonalChecklist() {
      var container = document.getElementById('checklistItems');
      var emptyState = document.getElementById('emptyChecklist');

      if (personalChecklist.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      container.style.display = 'block';
      emptyState.style.display = 'none';

      var html = '<div class="list-group">';

      personalChecklist.forEach(function(item) {
        var completedClass = item.completed ? 'list-group-item-success' : '';
        var strikethrough = item.completed ? 'text-decoration: line-through;' : '';

        html += '<div class="list-group-item ' + completedClass + '">';
        html += '<div class="d-flex justify-content-between align-items-start">';
        html += '<div class="form-check">';
        html += '<input class="form-check-input" type="checkbox" ' + (item.completed ? 'checked' : '') + ' onchange="toggleChecklistItemComplete(' + item.id + ')">';
        html += '<label class="form-check-label" style="' + strikethrough + '">';
        html += '<strong>' + (item.title || item.employee || 'Unknown Item') + '</strong>';
        html += '</label>';
        html += '</div>';
        html += '<button class="btn btn-outline-danger btn-sm" onclick="removeChecklistItemById(' + item.id + ')" title="Remove"><i class="bi bi-x-lg"></i></button>';
        html += '</div>';

        html += '<div class="ms-4 mt-1">';
        if (item.taskType || item.itemType) {
          html += '<div class="text-muted small"><i class="bi bi-card-checklist"></i> ' + (item.taskType || item.itemType || 'Task') + '</div>';
        }
        if (item.notes) {
          html += '<div class="text-muted small"><i class="bi bi-info-circle"></i> ' + item.notes + '</div>';
        }
        if (item.location) {
          html += '<div class="text-muted small"><i class="bi bi-geo-alt"></i> ' + item.location + '</div>';
        }
        if (item.scheduledDate) {
          html += '<div class="text-muted small"><i class="bi bi-calendar"></i> Scheduled: ' + item.scheduledDate;
          if (item.startTime) {
            html += ' at ' + item.startTime;
            if (item.endTime) html += ' - ' + item.endTime;
          }
          html += '</div>';
        }
        html += '<div class="text-muted small"><i class="bi bi-plus-circle"></i> Added: ' + item.addedDate + '</div>';
        html += '</div>';

        html += '</div>';
      });

      html += '</div>';
      container.innerHTML = html;
    }

    // ================== MANUAL ITEM FUNCTIONS ==================
    function showAddManualItemModal() {
      // Set default date to today
      var today = new Date().toISOString().split('T')[0];
      document.getElementById('manualTaskDate').value = today;
      document.getElementById('manualTaskTitle').value = '';
      document.getElementById('manualTaskNotes').value = '';
      document.getElementById('manualTaskLocation').value = '';
      document.getElementById('manualTaskStartTime').value = '';
      document.getElementById('manualTaskEndTime').value = '';
      document.getElementById('manualTaskPriority').value = 'Medium';
      document.getElementById('manualTaskAddToCalendar').checked = true;

      var modal = new bootstrap.Modal(document.getElementById('addManualItemModal'));
      modal.show();
    }

    function saveManualItem() {
      var title = document.getElementById('manualTaskTitle').value.trim();
      var notes = document.getElementById('manualTaskNotes').value.trim();
      var scheduledDate = document.getElementById('manualTaskDate').value;
      var location = document.getElementById('manualTaskLocation').value.trim();
      var startTime = document.getElementById('manualTaskStartTime').value;
      var endTime = document.getElementById('manualTaskEndTime').value;
      var priority = document.getElementById('manualTaskPriority').value;
      var addToCalendar = document.getElementById('manualTaskAddToCalendar').checked;

      if (!title) {
        alert('Please enter a task title');
        return;
      }

      // Create checklist item
      var checklistItem = {
        id: Date.now(),
        title: title,
        taskType: 'Manual Task',
        notes: notes,
        location: location,
        scheduledDate: scheduledDate,
        startTime: startTime,
        endTime: endTime,
        priority: priority,
        addedDate: new Date().toISOString().split('T')[0],
        completed: false,
        isManual: true
      };

      // Add to personal checklist
      personalChecklist.push(checklistItem);
      saveChecklistToStorage();
      updateChecklistBadge();
      renderPersonalChecklist();

      // Also add to main task list if checkbox is checked
      if (addToCalendar) {
        var manualTask = {
          taskType: title,
          source: 'Manual Tasks',
          employee: '',
          location: location || 'No Location',
          scheduledDate: scheduledDate,
          startTime: startTime,
          endTime: endTime,
          priority: priority,
          status: 'Pending',
          notes: notes,
          itemType: 'Manual'
        };

        // Save to server
        google.script.run
          .withSuccessHandler(function(result) {
            // Add to local allTasks array
            manualTask._originalIndex = allTasks.length;
            allTasks.push(manualTask);
            renderTasks(allTasks);
            renderCalendar();
            showToast('‚úì Item added to checklist and calendar!');
          })
          .withFailureHandler(function(error) {
            showToast('Added to checklist. Error adding to calendar: ' + error, 'error');
          })
          .addManualScheduleTask(manualTask);
      } else {
        showToast('‚úì Item added to your checklist!');
      }

      // Close modal
      var modal = bootstrap.Modal.getInstance(document.getElementById('addManualItemModal'));
      modal.hide();
    }

    // Load tasks on page load
    loadChecklistFromStorage();
    loadTasks();
  </script>
</body>
</html>

