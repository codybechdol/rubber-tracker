<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>To Do Schedule</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body { font-family: 'Google Sans', Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header h1 { color: #1a73e8; font-size: 24px; margin: 0; }
    .btn-primary { background: #1a73e8; border-color: #1a73e8; }
    .btn-primary:hover { background: #1557b0; border-color: #1557b0; }
    .card { border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.12); margin-bottom: 16px; }
    .card-header { background: #1a73e8; color: white; font-weight: 500; }
    .task-row { padding: 12px; border-bottom: 1px solid #e0e0e0; }
    .task-row:last-child { border-bottom: none; }
    .task-row:hover { background: #f1f3f4; }
    .priority-high { border-left: 4px solid #ea4335; }
    .priority-medium { border-left: 4px solid #fbbc04; }
    .priority-low { border-left: 4px solid #34a853; }
    .task-date { font-size: 12px; color: #5f6368; }
    .task-location { font-weight: 500; color: #202124; }
    .task-type { color: #5f6368; }
    .loading { text-align: center; padding: 40px; }
    .empty-state { text-align: center; padding: 60px; color: #5f6368; }
    .date-input { border: 1px solid #dadce0; border-radius: 4px; padding: 4px 8px; font-size: 13px; }
    .date-input:focus { outline: none; border-color: #1a73e8; }
    .status-badge { font-size: 11px; padding: 2px 8px; border-radius: 12px; }
    .status-pending { background: #fef7e0; color: #b06000; }
    .status-complete { background: #e6f4ea; color: #137333; }
    .filter-bar { background: white; padding: 12px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
  </style>
</head>
<body>
  <div class="header">
    <h1><i class="bi bi-calendar-check"></i> To Do Schedule</h1>
    <div>
      <button class="btn btn-outline-secondary btn-sm me-2" onclick="refreshData()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
      <button class="btn btn-primary btn-sm" onclick="google.script.host.close()">
        <i class="bi bi-x-lg"></i> Close
      </button>
    </div>
  </div>

  <div class="filter-bar">
    <div class="row align-items-center">
      <div class="col-auto">
        <label class="form-label mb-0 me-2">Filter:</label>
      </div>
      <div class="col-auto">
        <select id="filterPriority" class="form-select form-select-sm" onchange="applyFilters()">
          <option value="">All Priorities</option>
          <option value="High">ðŸ”´ High</option>
          <option value="Medium">ðŸŸ¡ Medium</option>
          <option value="Low">ðŸŸ¢ Low</option>
        </select>
      </div>
      <div class="col-auto">
        <select id="filterStatus" class="form-select form-select-sm" onchange="applyFilters()">
          <option value="">All Status</option>
          <option value="Pending">Pending</option>
          <option value="Complete">Complete</option>
        </select>
      </div>
      <div class="col-auto">
        <input type="date" id="filterDate" class="form-control form-control-sm" onchange="applyFilters()">
      </div>
      <div class="col-auto">
        <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">Clear</button>
      </div>
    </div>
  </div>

  <div id="taskContainer">
    <div class="loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Loading tasks...</p>
    </div>
  </div>

  <script>
    var allTasks = [];

    function loadTasks() {
      google.script.run
        .withSuccessHandler(function(tasks) {
          allTasks = tasks || [];
          renderTasks(allTasks);
        })
        .withFailureHandler(function(error) {
          document.getElementById('taskContainer').innerHTML =
            '<div class="alert alert-danger">Error loading tasks: ' + error + '</div>';
        })
        .getScheduleTasks();
    }

    function renderTasks(tasks) {
      var container = document.getElementById('taskContainer');

      if (!tasks || tasks.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x" style="font-size: 48px;"></i><p class="mt-3">No tasks found</p><p class="text-muted">Add tasks from the Quick Actions sidebar</p></div>';
        return;
      }

      var html = '<div class="card"><div class="card-header"><i class="bi bi-list-task"></i> Scheduled Tasks (' + tasks.length + ')</div><div class="card-body p-0">';

      tasks.forEach(function(task, index) {
        var priorityClass = 'priority-' + (task.priority || 'medium').toLowerCase();
        var statusClass = task.status === 'Complete' ? 'status-complete' : 'status-pending';

        html += '<div class="task-row ' + priorityClass + '">';
        html += '<div class="row align-items-center">';
        html += '<div class="col-md-3">';
        html += '<div class="task-location">' + (task.location || 'No Location') + '</div>';
        html += '<div class="task-type">' + (task.taskType || 'Task') + '</div>';
        html += '</div>';
        html += '<div class="col-md-2">';
        html += '<input type="date" class="date-input" value="' + (task.scheduledDate || '') + '" onchange="updateTaskDate(' + index + ', this.value)">';
        html += '</div>';
        html += '<div class="col-md-2">';
        html += '<span class="task-date">' + (task.startTime || '') + (task.endTime ? ' - ' + task.endTime : '') + '</span>';
        html += '</div>';
        html += '<div class="col-md-2">';
        html += '<span class="status-badge ' + statusClass + '">' + (task.status || 'Pending') + '</span>';
        html += '</div>';
        html += '<div class="col-md-3 text-end">';
        html += '<button class="btn btn-outline-success btn-sm me-1" onclick="markComplete(' + index + ')" title="Mark Complete"><i class="bi bi-check-lg"></i></button>';
        html += '<button class="btn btn-outline-danger btn-sm" onclick="deleteTask(' + index + ')" title="Delete"><i class="bi bi-trash"></i></button>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });

      html += '</div></div>';
      container.innerHTML = html;
    }

    function updateTaskDate(index, newDate) {
      google.script.run
        .withSuccessHandler(function() {
          allTasks[index].scheduledDate = newDate;
          showToast('Date updated successfully');
        })
        .withFailureHandler(function(error) {
          showToast('Error updating date: ' + error, 'error');
          loadTasks(); // Reload to restore correct state
        })
        .updateScheduleTaskDate(index, newDate);
    }

    function markComplete(index) {
      google.script.run
        .withSuccessHandler(function() {
          allTasks[index].status = 'Complete';
          renderTasks(allTasks);
          showToast('Task marked complete');
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error, 'error');
        })
        .markScheduleTaskComplete(index);
    }

    function deleteTask(index) {
      if (!confirm('Are you sure you want to delete this task?')) return;

      google.script.run
        .withSuccessHandler(function() {
          allTasks.splice(index, 1);
          renderTasks(allTasks);
          showToast('Task deleted');
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error, 'error');
        })
        .deleteScheduleTask(index);
    }

    function applyFilters() {
      var priority = document.getElementById('filterPriority').value;
      var status = document.getElementById('filterStatus').value;
      var date = document.getElementById('filterDate').value;

      var filtered = allTasks.filter(function(task) {
        if (priority && task.priority !== priority) return false;
        if (status && task.status !== status) return false;
        if (date && task.scheduledDate !== date) return false;
        return true;
      });

      renderTasks(filtered);
    }

    function clearFilters() {
      document.getElementById('filterPriority').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterDate').value = '';
      renderTasks(allTasks);
    }

    function refreshData() {
      document.getElementById('taskContainer').innerHTML = '<div class="loading"><div class="spinner-border text-primary"></div><p class="mt-3">Refreshing...</p></div>';
      loadTasks();
    }

    function showToast(message, type) {
      var toast = document.createElement('div');
      toast.className = 'alert alert-' + (type === 'error' ? 'danger' : 'success') + ' position-fixed';
      toast.style.cssText = 'bottom: 20px; right: 20px; z-index: 9999; animation: fadeIn 0.3s;';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(function() { toast.remove(); }, 3000);
    }

    // Load tasks on page load
    loadTasks();
  </script>
</body>
</html>

