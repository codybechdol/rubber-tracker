<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import Certifications</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body { font-family: 'Google Sans', Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header h1 { color: #1a73e8; font-size: 24px; margin: 0; }
    .btn-primary { background: #1a73e8; border-color: #1a73e8; }
    .btn-primary:hover { background: #1557b0; border-color: #1557b0; }
    .config-section { padding: 20px; background: white; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .config-section h3 { color: #202124; font-size: 16px; margin-bottom: 16px; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; }
    .cert-checkboxes { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .form-check { margin-bottom: 0; }
    .form-check-label { font-size: 13px; }
    textarea { font-family: 'Courier New', monospace; font-size: 12px; }
    .preview-table { font-size: 13px; }
    .match-exact { background-color: #e6f4ea; }
    .match-variant { background-color: #fef7e0; }
    .match-none { background-color: #fce8e6; }
    .summary-card { background: #e8f0fe; border-left: 4px solid #1a73e8; padding: 16px; margin-bottom: 16px; }
    .summary-stat { display: inline-block; margin-right: 20px; }
    .summary-stat strong { color: #1a73e8; }
    .alert-validation { font-size: 13px; }
    .loading { text-align: center; padding: 40px; }
  </style>
</head>
<body>
  <div class="header">
    <h1><i class="bi bi-file-earmark-arrow-up"></i> Import Expiring Certifications</h1>
    <div>
      <button class="btn btn-success btn-sm me-2" id="btnConfirmImport" onclick="confirmImport()" disabled>
        <i class="bi bi-check-lg"></i> Confirm Import
      </button>
      <button class="btn btn-primary btn-sm" onclick="google.script.host.close()">
        <i class="bi bi-x-lg"></i> Close
      </button>
    </div>
  </div>

  <!-- Cert Type Checkboxes -->
  <div class="config-section">
    <h3><i class="bi bi-list-check"></i> üéØ Create To Do Tasks For:</h3>
    <p class="text-muted small mb-3">Select which certification types should generate tasks in your To Do list when expiring soon or marked as priority.</p>
    <div class="cert-checkboxes" id="certCheckboxes">
      <!-- Will be populated by JavaScript -->
    </div>
  </div>

  <!-- Instructions -->
  <div class="config-section">
    <h3><i class="bi bi-info-circle"></i> Instructions</h3>
    <p class="text-muted small mb-2">Paste tab-separated data from Excel starting with employee names (no headers).</p>
    <p class="text-muted small mb-0"><strong>Expected format:</strong> Column A=Name (LastName, FirstName), B=Job#, C=Location, then D=DL, E=Med, F=1st Aid, G=CPR, H=Crane Cert, I=Crane Evaluation, J=OSHA 1910, K=BNSF, L=MSHA, M=OSHA Trench Comp Person, N=Forklift, O=Forklift Operator Safety Training, P=Rigging & Signaling, Q=Harassment Training, R=EICA Basic Helo</p>
    <p class="text-muted small mt-2"><strong>Non-expiring certs:</strong> Crane Evaluation, OSHA 1910, BNSF, MSHA, EICA Basic Helo (dates will be ignored)</p>
  </div>

  <!-- Paste Area -->
  <div class="config-section">
    <h3><i class="bi bi-clipboard"></i> Paste Excel Data</h3>
    <textarea class="form-control" id="excelData" rows="12" placeholder="Paste Excel data here (Ctrl+V)..."></textarea>
    <div class="mt-3">
      <button class="btn btn-primary" onclick="parseData()">
        <i class="bi bi-search"></i> Parse & Preview
      </button>
    </div>
  </div>

  <!-- Column Mapping (Advanced) -->
  <div class="config-section">
    <div class="accordion" id="advancedAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMapping">
            <i class="bi bi-gear"></i> ‚öôÔ∏è Advanced: Configure Column Mapping
          </button>
        </h2>
        <div id="collapseMapping" class="accordion-collapse collapse" data-bs-parent="#advancedAccordion">
          <div class="accordion-body">
            <p class="text-muted small">Customize which Excel column maps to which certification type (only needed if your Excel format differs from standard).</p>
            <div id="columnMapper" class="row g-2">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Section -->
  <div id="previewSection" style="display: none;">
    <!-- Summary Statistics -->
    <div class="summary-card">
      <h4 class="mb-3"><i class="bi bi-graph-up"></i> üìä Import Summary</h4>
      <div id="summaryStats">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>

    <!-- Validation Warnings -->
    <div id="validationWarnings"></div>

    <!-- Preview Table -->
    <div class="config-section">
      <h3><i class="bi bi-table"></i> Preview: Employee Matching</h3>
      <div class="table-responsive">
        <table class="table table-sm preview-table">
          <thead>
            <tr>
              <th>Excel Name</th>
              <th>Matched Employee</th>
              <th>Confidence</th>
              <th>Cert Count</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="previewTableBody">
            <!-- Will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Unmatched Employees -->
    <div id="unmatchedSection"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    var certTypes = [];
    var defaultChecked = [];
    var nonExpiring = [];
    var columnMapping = {};
    var parsedData = null;
    var employees = [];

    function init() {
      google.script.run
        .withSuccessHandler(function(config) {
          certTypes = config.allCertTypes;
          defaultChecked = config.defaultChecked;
          nonExpiring = config.nonExpiring;
          columnMapping = config.defaultMapping;
          renderCertCheckboxes();
          renderColumnMapper();
        })
        .getCertTypeDefaults();

      google.script.run
        .withSuccessHandler(function(empList) {
          employees = empList;
        })
        .getEmployeeNamesForMatching();
    }

    function renderCertCheckboxes() {
      var container = document.getElementById('certCheckboxes');
      var html = '';
      certTypes.forEach(function(cert) {
        var checked = defaultChecked.includes(cert) ? 'checked' : '';
        var isNonExp = nonExpiring.includes(cert);
        var label = cert + (isNonExp ? ' (Non-Expiring)' : '');
        html += '<div class="form-check">';
        html += '<input class="form-check-input" type="checkbox" id="cert-' + cert.replace(/[^a-zA-Z0-9]/g, '') + '" value="' + cert + '" ' + checked + '>';
        html += '<label class="form-check-label" for="cert-' + cert.replace(/[^a-zA-Z0-9]/g, '') + '">' + label + '</label>';
        html += '</div>';
      });
      container.innerHTML = html;
    }

    function renderColumnMapper() {
      var container = document.getElementById('columnMapper');
      var html = '';
      var columns = ['D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R'];
      columns.forEach(function(col) {
        html += '<div class="col-md-4">';
        html += '<label class="form-label small">Column ' + col + '</label>';
        html += '<select class="form-select form-select-sm" id="map-' + col + '">';
        certTypes.forEach(function(cert) {
          var selected = columnMapping[col] === cert ? 'selected' : '';
          html += '<option value="' + cert + '" ' + selected + '>' + cert + '</option>';
        });
        html += '</select>';
        html += '</div>';
      });
      container.innerHTML = html;
    }

    function getSelectedCertTypes() {
      var selected = [];
      certTypes.forEach(function(cert) {
        var checkbox = document.getElementById('cert-' + cert.replace(/[^a-zA-Z0-9]/g, ''));
        if (checkbox && checkbox.checked) {
          selected.push(cert);
        }
      });
      return selected;
    }

    function getColumnMapping() {
      var mapping = {};
      var columns = ['D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R'];
      columns.forEach(function(col) {
        var select = document.getElementById('map-' + col);
        if (select) {
          mapping[col] = select.value;
        }
      });
      return mapping;
    }

    function parseData() {
      var text = document.getElementById('excelData').value.trim();
      if (!text) {
        alert('Please paste Excel data first');
        return;
      }

      var mapping = getColumnMapping();

      google.script.run
        .withSuccessHandler(function(result) {
          parsedData = result;
          displayPreview(result);
        })
        .withFailureHandler(function(error) {
          alert('Error parsing data: ' + error);
        })
        .parseExcelCertDataMultiRow(text, mapping);
    }

    function displayPreview(result) {
      document.getElementById('previewSection').style.display = 'block';

      // Summary stats
      var summary = result.summary;
      var statsHtml = '<div class="row">';
      statsHtml += '<div class="col-md-3"><div class="summary-stat"><strong>' + summary.totalEmployees + '</strong><br><small>Total Employees</small></div></div>';
      statsHtml += '<div class="col-md-3"><div class="summary-stat"><strong>' + summary.totalCerts + '</strong><br><small>Total Certifications</small></div></div>';
      statsHtml += '<div class="col-md-3"><div class="summary-stat"><strong>' + summary.priorityCount + '</strong><br><small>Priority Items</small></div></div>';
      statsHtml += '<div class="col-md-3"><div class="summary-stat"><strong>' + summary.nonExpiringCount + '</strong><br><small>Non-Expiring</small></div></div>';
      statsHtml += '</div>';
      document.getElementById('summaryStats').innerHTML = statsHtml;

      // Validation warnings
      if (summary.validationWarnings && summary.validationWarnings.length > 0) {
        var warningsHtml = '<div class="alert alert-warning alert-validation"><strong>‚ö†Ô∏è Warnings:</strong><ul class="mb-0 mt-2">';
        summary.validationWarnings.forEach(function(warning) {
          warningsHtml += '<li>' + warning + '</li>';
        });
        warningsHtml += '</ul></div>';
        document.getElementById('validationWarnings').innerHTML = warningsHtml;
      } else {
        document.getElementById('validationWarnings').innerHTML = '';
      }

      // Preview table
      var tableHtml = '';
      result.employeeMatches.forEach(function(match) {
        var rowClass = match.confidence === 100 ? 'match-exact' : (match.confidence >= 70 ? 'match-variant' : 'match-none');
        var statusText = '';

        if (match.confidence === 100) {
          statusText = '‚úì Exact';
          if (match.isPreviousEmployee) {
            statusText += ' <span class="badge bg-warning text-dark">Previous Employee</span>';
          }
        } else if (match.confidence >= 70) {
          statusText = '‚ö†Ô∏è Variant';
          if (match.isPreviousEmployee) {
            statusText += ' <span class="badge bg-warning text-dark">Previous Employee</span>';
          }
        } else {
          statusText = '‚ùå Unmatched';
        }

        tableHtml += '<tr class="' + rowClass + '">';
        tableHtml += '<td>' + match.excelName + '</td>';
        tableHtml += '<td>' + (match.matchedName || 'No match') + '</td>';
        tableHtml += '<td>' + (match.confidence ? match.confidence + '%' : 'N/A') + '</td>';
        tableHtml += '<td>' + match.certCount + '</td>';
        tableHtml += '<td>' + statusText + '</td>';
        tableHtml += '</tr>';
      });
      document.getElementById('previewTableBody').innerHTML = tableHtml;

      // Enable import button if no unmatched
      var hasUnmatched = result.employeeMatches.some(function(m) { return m.confidence < 70; });
      if (!hasUnmatched) {
        // Check for previous employees that need confirmation
        var hasPreviousEmployees = result.employeeMatches.some(function(m) {
          return m.isPreviousEmployee && m.confidence >= 70;
        });

        if (hasPreviousEmployees) {
          displayPreviousEmployeeConfirmation(result.employeeMatches.filter(function(m) {
            return m.isPreviousEmployee && m.confidence >= 70;
          }));
        } else {
          document.getElementById('btnConfirmImport').disabled = false;
        }
      } else {
        displayUnmatchedResolution(result.employeeMatches.filter(function(m) { return m.confidence < 70; }));
      }
    }

    function displayPreviousEmployeeConfirmation(previousEmps) {
      var html = '<div class="config-section"><h3><i class="bi bi-person-badge"></i> ‚ö†Ô∏è Confirm Previous Employees</h3>';
      html += '<p class="text-muted small">The following matches are for employees who are no longer active. Please confirm these are correct.</p>';

      previousEmps.forEach(function(emp, index) {
        html += '<div class="card mb-3" style="border-left: 4px solid #ffc107;">';
        html += '<div class="card-header bg-warning bg-opacity-10"><strong>' + emp.excelName + '</strong> ‚Üí ' + emp.matchedName + ' <span class="badge bg-warning text-dark">Previous Employee</span></div>';
        html += '<div class="card-body">';
        html += '<p class="mb-2 small">This employee appears in Employee History as a terminated/previous employee.</p>';

        html += '<div class="btn-group btn-group-sm w-100" role="group">';
        html += '<button class="btn btn-success" onclick="confirmPreviousEmployee(\'' + emp.excelName + '\', \'' + emp.matchedName + '\', ' + index + ')">‚úì Confirm - This is Correct</button>';
        html += '<button class="btn btn-outline-warning" onclick="chooseDifferentMatch(' + index + ')">Choose Different Match</button>';
        html += '<button class="btn btn-outline-secondary" onclick="skipEmployee(' + index + ')">‚è≠Ô∏è Skip</button>';
        html += '</div>';
        html += '</div></div>';
      });

      html += '</div>';
      document.getElementById('unmatchedSection').innerHTML = html;
    }

    function confirmPreviousEmployee(excelName, matchedName, index) {
      if (!parsedData.confirmedPreviousEmployees) {
        parsedData.confirmedPreviousEmployees = {};
      }
      parsedData.confirmedPreviousEmployees[excelName] = matchedName;

      // Remove this card
      var cards = document.querySelectorAll('#unmatchedSection .card');
      if (cards[index]) {
        cards[index].remove();
      }

      // Check if all previous employees are confirmed
      var remainingCards = document.querySelectorAll('#unmatchedSection .card');
      if (remainingCards.length === 0) {
        document.getElementById('unmatchedSection').innerHTML = '';
        document.getElementById('btnConfirmImport').disabled = false;
      }
    }

    function chooseDifferentMatch(index) {
      alert('Choose different match functionality - showing suggestions');
      // This will show the same resolution dialog as unmatched employees
    }

    function displayUnmatchedResolution(unmatched) {
      var html = '<div class="config-section"><h3><i class="bi bi-person-x"></i> Resolve Unmatched Employees</h3>';
      html += '<p class="text-muted small">The following employees need to be matched or added as new employees.</p>';

      unmatched.forEach(function(emp, index) {
        html += '<div class="card mb-3">';
        html += '<div class="card-header"><strong>' + emp.excelName + '</strong></div>';
        html += '<div class="card-body">';

        if (emp.suggestions && emp.suggestions.length > 0) {
          html += '<label class="form-label small">Suggested matches:</label>';
          html += '<select class="form-select form-select-sm mb-2" id="match-' + index + '">';
          html += '<option value="">-- Select employee --</option>';
          emp.suggestions.forEach(function(sug) {
            var previousBadge = sug.isPreviousEmployee ? ' [PREVIOUS EMPLOYEE]' : '';
            html += '<option value="' + sug.name + '" data-previous="' + (sug.isPreviousEmployee || false) + '">' + sug.name + ' (' + sug.confidence + '% match)' + previousBadge + '</option>';
          });
          html += '</select>';
        }

        html += '<div class="btn-group btn-group-sm w-100" role="group">';
        html += '<button class="btn btn-outline-primary" onclick="updateEmployeeName(\'' + emp.excelName + '\', ' + index + ')">‚úèÔ∏è Update Employee Sheet</button>';
        html += '<button class="btn btn-outline-success" onclick="addNewEmployee(\'' + emp.excelName + '\', ' + index + ')">‚ûï Add New Employee</button>';
        html += '<button class="btn btn-outline-secondary" onclick="skipEmployee(' + index + ')">‚è≠Ô∏è Skip</button>';
        html += '</div>';
        html += '</div></div>';
      });

      html += '</div>';
      document.getElementById('unmatchedSection').innerHTML = html;
    }

    var resolvedEmployees = {};

    function updateEmployeeName(excelName, index) {
      // For now, just mark as resolved and remove card
      resolvedEmployees[excelName] = { action: 'update', newName: excelName };
      removeCardAndCheckCompletion(index);
    }

    function addNewEmployee(excelName, index) {
      // Show modal to collect new employee data
      showNewEmployeeModal(excelName, index);
    }

    function skipEmployee(index) {
      var cards = document.querySelectorAll('#unmatchedSection .card');
      if (cards[index]) {
        var excelName = cards[index].querySelector('.card-header strong').textContent.trim();
        resolvedEmployees[excelName] = { action: 'skip' };
        cards[index].remove();
      }
      checkAllResolved();
    }

    function removeCardAndCheckCompletion(index) {
      var cards = document.querySelectorAll('#unmatchedSection .card');
      if (cards[index]) {
        cards[index].remove();
      }
      checkAllResolved();
    }

    function checkAllResolved() {
      var remainingCards = document.querySelectorAll('#unmatchedSection .card');
      if (remainingCards.length === 0) {
        document.getElementById('unmatchedSection').innerHTML = '<div class="alert alert-success">‚úì All employees resolved! You can now confirm the import.</div>';
        document.getElementById('btnConfirmImport').disabled = false;
      }
    }

    function showNewEmployeeModal(excelName, index) {
      var modalHtml = '<div class="modal fade" id="newEmployeeModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">';
      modalHtml += '<div class="modal-header"><h5 class="modal-title">‚ûï Add New Employee</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>';
      modalHtml += '<div class="modal-body">';
      modalHtml += '<p class="text-muted mb-3">Add <strong>' + excelName + '</strong> as a new employee to the system.</p>';

      modalHtml += '<div class="row g-3">';
      modalHtml += '<div class="col-md-6"><label class="form-label">Name *</label><input type="text" class="form-control" id="newEmpName" value="' + excelName + '"></div>';
      modalHtml += '<div class="col-md-3"><label class="form-label">Class *</label><select class="form-select" id="newEmpClass"><option value="">Select...</option><option value="00">00</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>';
      modalHtml += '<div class="col-md-3"><label class="form-label">Location *</label><input type="text" class="form-control" id="newEmpLocation" placeholder="e.g., Helena"></div>';
      modalHtml += '<div class="col-md-6"><label class="form-label">Job Number</label><input type="text" class="form-control" id="newEmpJobNum" placeholder="Optional"></div>';
      modalHtml += '<div class="col-md-6"><label class="form-label">Phone</label><input type="tel" class="form-control" id="newEmpPhone" placeholder="(123) 456-7890"></div>';
      modalHtml += '<div class="col-md-6"><label class="form-label">Email</label><input type="email" class="form-control" id="newEmpEmail" placeholder="employee@example.com"></div>';
      modalHtml += '<div class="col-md-3"><label class="form-label">Glove Size</label><select class="form-select" id="newEmpGloveSize"><option value="">Select...</option><option>8</option><option>8.5</option><option>9</option><option>9.5</option><option>10</option><option>10.5</option><option>11</option><option>11.5</option><option>12</option></select></div>';
      modalHtml += '<div class="col-md-3"><label class="form-label">Sleeve Size</label><select class="form-select" id="newEmpSleeveSize"><option value="">Select...</option><option>0</option><option>2</option><option>3</option><option>4</option></select></div>';
      modalHtml += '<div class="col-md-6"><label class="form-label">Hire Date</label><input type="date" class="form-control" id="newEmpHireDate" value="' + new Date().toISOString().split('T')[0] + '"></div>';
      modalHtml += '</div>';

      modalHtml += '</div><div class="modal-footer">';
      modalHtml += '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>';
      modalHtml += '<button type="button" class="btn btn-success" onclick="saveNewEmployee(\'' + excelName + '\', ' + index + ')">Save Employee</button>';
      modalHtml += '</div></div></div></div>';

      // Remove existing modal if present
      var existingModal = document.getElementById('newEmployeeModal');
      if (existingModal) existingModal.remove();

      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // Show modal
      var modal = new bootstrap.Modal(document.getElementById('newEmployeeModal'));
      modal.show();
    }

    function saveNewEmployee(excelName, index) {
      // Validate required fields
      var name = document.getElementById('newEmpName').value.trim();
      var empClass = document.getElementById('newEmpClass').value;
      var location = document.getElementById('newEmpLocation').value.trim();

      if (!name || !empClass || !location) {
        alert('Please fill in all required fields (Name, Class, Location)');
        return;
      }

      var newEmpData = {
        name: name,
        class: empClass,
        location: location,
        jobNum: document.getElementById('newEmpJobNum').value.trim(),
        phone: document.getElementById('newEmpPhone').value.trim(),
        email: document.getElementById('newEmpEmail').value.trim(),
        gloveSize: document.getElementById('newEmpGloveSize').value,
        sleeveSize: document.getElementById('newEmpSleeveSize').value,
        hireDate: document.getElementById('newEmpHireDate').value
      };

      // Store new employee data
      if (!parsedData.newEmployees) {
        parsedData.newEmployees = [];
      }
      parsedData.newEmployees.push(newEmpData);

      resolvedEmployees[excelName] = { action: 'addNew', data: newEmpData };

      // Close modal
      var modal = bootstrap.Modal.getInstance(document.getElementById('newEmployeeModal'));
      modal.hide();

      // Remove card and check if done
      removeCardAndCheckCompletion(index);

      showStatus('‚úì New employee ' + name + ' will be added', 'success');
      setTimeout(hideStatus, 2000);
    }

    function confirmImport() {
      if (!parsedData) {
        alert('Please parse data first');
        return;
      }

      var selectedCerts = getSelectedCertTypes();

      if (confirm('This will replace all existing certification data. Continue?')) {
        document.getElementById('btnConfirmImport').disabled = true;
        document.getElementById('btnConfirmImport').innerHTML = '<span class="spinner-border spinner-border-sm"></span> Importing...';

        google.script.run
          .withSuccessHandler(function(result) {
            alert(result.message);

            // Ask if user wants to email report
            if (confirm('Import complete! Would you like to email a certification report to managers?')) {
              sendEmailReport();
            } else {
              google.script.host.close();
            }
          })
          .withFailureHandler(function(error) {
            alert('Error during import: ' + error);
            document.getElementById('btnConfirmImport').disabled = false;
            document.getElementById('btnConfirmImport').innerHTML = '<i class="bi bi-check-lg"></i> Confirm Import';
          })
          .processExpiringCertsImportMultiRow(parsedData, selectedCerts);
      }
    }

    function showStatus(message, type) {
      // Create a toast notification
      var toast = document.createElement('div');
      toast.className = 'alert alert-' + (type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info');
      toast.style.position = 'fixed';
      toast.style.top = '20px';
      toast.style.right = '20px';
      toast.style.zIndex = '9999';
      toast.style.minWidth = '300px';
      toast.innerHTML = message;
      document.body.appendChild(toast);

      setTimeout(function() {
        toast.remove();
      }, 3000);
    }

    function hideStatus() {
      // Status messages auto-hide
    }

    function sendEmailReport() {
      showStatus('üìß Sending email report...', 'info');

      google.script.run
        .withSuccessHandler(function(result) {
          showStatus(result.message, 'success');
          setTimeout(function() {
            google.script.host.close();
          }, 2000);
        })
        .withFailureHandler(function(error) {
          showStatus('Email error: ' + error, 'error');
          setTimeout(function() {
            google.script.host.close();
          }, 3000);
        })
        .emailCertificationReport();
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
