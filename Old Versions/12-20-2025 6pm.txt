12/20/2025 6pm Glove Swaps. More to do with addition and removal of Date Assigned. Change Glove tab Change Out Date auto adjust next. 



/**
 * Glove Manager â€“ Rubber Glove & Sleeve Inventory System
 *
 * Google Apps Script foundation for automating and managing PPE inventory, assignments, swaps, compliance, and reporting.
 *
 * Sheet Interactions:
 * - Employees feeds Gloves, Sleeves, Glove Swaps, Sleeve Swaps, Reclaims
 * - Gloves/Sleeves feed Swaps, Purchase Needs, Inventory Reports, History, Reclaims
 * - Swaps update Gloves/Sleeves, Employees, History
 * - Purchase Needs and Inventory Reports aggregate/analyze inventory
 * - Reclaims cross-checks assignments for compliance
 * - History logs all changes
 *
 * Expand each placeholder as features are implemented. Logging and error handling included for maintainability.
 */

// Sheet/tab name constants
const SHEET_EMPLOYEES = 'Employees';
const SHEET_GLOVES = 'Gloves';
const SHEET_SLEEVES = 'Sleeves';
const SHEET_GLOVE_SWAPS = 'Glove Swaps';
const SHEET_SLEEVE_SWAPS = 'Sleeve Swaps';
const SHEET_PURCHASE_NEEDS = 'Purchase Needs';
const SHEET_INVENTORY_REPORTS = 'Inventory Reports';
const SHEET_RECLAIMS = 'Reclaims';
const SHEET_HISTORY = 'History';

// Header background color for swap tables
const HEADER_BG_COLOR = '#1565c0';

/**
 * Writes dynamic swap table headers for Glove/Sleeve Swaps sheets.
 * Supports any number of swap workflow stages.
 * @param {Sheet} swapSheet - The sheet to write headers to.
 * @param {number} currentRow - The row to start writing headers (1-based).
 * @param {string} itemType - 'Gloves' or 'Sleeves'.
 * @param {string} headerFont - Font color for visible headers.
 * @param {number} numStages - Number of swap workflow stages.
 * @return {number} The next available row after headers.
 */
function writeSwapTableHeadersDynamic(swapSheet, currentRow, itemType, headerFont, numStages) {
  const itemNumHeader = itemType === 'Gloves' ? 'Current Glove #' : 'Current Sleeve #';
  const itemSingular = itemType === 'Gloves' ? 'Glove' : 'Sleeve';

  // Write dynamic hidden storage group headers for each stage
  // Stage 1: K-M
  swapSheet.getRange(currentRow, 11, 1, 3).merge().setValue('Pick List ' + itemType + ' Stage 1');
  swapSheet.getRange(currentRow, 11, 1, 3)
    .setFontWeight('bold').setBackground(HEADER_BG_COLOR).setFontColor('white')
    .setHorizontalAlignment('center').setFontSize(8);
  // Stage 2: N-P
  swapSheet.getRange(currentRow, 14, 1, 3).merge().setValue('Pick List ' + itemType + ' Stage 2');
  swapSheet.getRange(currentRow, 14, 1, 3)
    .setFontWeight('bold').setBackground(HEADER_BG_COLOR).setFontColor('white')
    .setHorizontalAlignment('center').setFontSize(8);
  // Picked For: Q
  swapSheet.getRange(currentRow, 17, 1, 1).setValue('Picked For');
  swapSheet.getRange(currentRow, 17, 1, 1)
    .setFontWeight('bold').setBackground(HEADER_BG_COLOR).setFontColor('white')
    .setHorizontalAlignment('center').setFontSize(8);
  // Stage 3: R-T
  swapSheet.getRange(currentRow, 18, 1, 3).merge().setValue('Pick List ' + itemType + ' Stage 3');
  swapSheet.getRange(currentRow, 18, 1, 3)
    .setFontWeight('bold').setBackground(HEADER_BG_COLOR).setFontColor('white')
    .setHorizontalAlignment('center').setFontSize(8);
  // Old Assignment: U-W
  swapSheet.getRange(currentRow, 21, 1, 3).merge().setValue('Old ' + itemSingular + ' Assignment');
  swapSheet.getRange(currentRow, 21, 1, 3)
    .setFontWeight('bold').setBackground(HEADER_BG_COLOR).setFontColor('white')
    .setHorizontalAlignment('center').setFontSize(8);
  currentRow++;

  // Custom header order for Glove Swaps tab
  const visibleHeaders = [
    'Employee',           // A
    'Current Glove #',    // B
    'Size',               // C
    'Date Assigned',      // D
    'Change Out Date',    // E
    'Days Left',          // F
    'Pick List',          // G
    'Status',             // H
    'Picked',             // I
    'Date Changed',       // J
    // Hidden columns for swap workflow
    'Status',             // K (Stage 1)
    'Assigned To',        // L
    'Date Assigned',      // M
    'Status',             // N (Stage 2)
    'Assigned To',        // O
    'Date Assigned',      // P
    'Picked For',         // Q
    'Status',             // R (Stage 3)
    'Assigned To',        // S
    'Date Assigned',      // T
    'Assigned To',        // U (Old Assignment)
    'Date Assigned',      // V
    'Change Out Date'     // W
  ];
  swapSheet.getRange(currentRow, 1, 1, visibleHeaders.length).setValues([visibleHeaders]);
  swapSheet.getRange(currentRow, 1, 1, visibleHeaders.length)
    .setFontWeight('bold').setFontColor(headerFont).setHorizontalAlignment('center').setBackground(HEADER_BG_COLOR);
  currentRow++;

  // Hidden storage headers (K-W)
  const hiddenHeaders = [
    'Status', 'Assigned To', 'Date Assigned', // K-M (Stage 1)
    'Status', 'Assigned To', 'Date Assigned', // N-P (Stage 2)
    'Picked For',                             // Q
    'Status', 'Assigned To', 'Date Assigned', // R-T (Stage 3)
    'Assigned To', 'Date Assigned', 'Change Out Date' // U-W (Old Assignment)
  ];
  swapSheet.getRange(currentRow, 11, 1, hiddenHeaders.length).setValues([hiddenHeaders]);
  swapSheet.getRange(currentRow, 11, 1, hiddenHeaders.length)
    .setFontWeight('bold').setBackground(HEADER_BG_COLOR).setFontColor('white')
    .setHorizontalAlignment('center').setFontSize(8);

  currentRow++;
  return currentRow;
}

/**
 * Adds a custom menu to the Google Sheet for Glove Manager actions.
 */
function onOpen() {
  ensurePickedForColumn();
  ensureGloveSwapsPickedForColumn();
  SpreadsheetApp.getUi()
    .createMenu('Glove Manager')
    .addItem('Build Sheets', 'buildSheets')
    .addItem('Generate All Reports', 'generateAllReports')
    .addSeparator()
    .addItem('Generate Glove Swaps', 'generateGloveSwaps')
    .addItem('Generate Sleeve Swaps', 'generateSleeveSwaps')
    .addItem('Update Purchase Needs', 'updatePurchaseNeeds')
    .addItem('Update Inventory Reports', 'updateInventoryReports')
    .addItem('Run Reclaims Check', 'runReclaimsCheck')
    .addItem('View History', 'viewHistory')
    .addToUi();
}

/**
 * Logging utility for consistent logs and error tracking.
 */
function logEvent(message, level = 'INFO') {
  const now = new Date();
  Logger.log(`[${level}] [${now.toISOString()}] ${message}`);
}

/**
 * Idempotently creates all required sheets/tabs and headers for the Glove Manager system.
 */
function buildSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetDefs = [
    { name: SHEET_EMPLOYEES, headers: ['Name', 'Class', 'Location', 'Job Number', 'Phone Number', 'Notification Emails', 'MP Email', 'Email Address', 'Glove Size', 'Sleeve Size'] },
    { name: SHEET_GLOVES, headers: ['Glove', 'Size', 'Class', 'Test Date', 'Date Assigned', 'Location', 'Status', 'Assigned To', 'Change Out Date', 'Notes'] },
    { name: SHEET_SLEEVES, headers: ['Sleeve', 'Size', 'Class', 'Test Date', 'Date Assigned', 'Location', 'Status', 'Assigned To', 'Change Out Date', 'Notes'] },
    { name: SHEET_GLOVE_SWAPS, headers: ['Employee', 'Item Number', 'Size', 'Date Assigned', 'Change Out Date', 'Days Left', 'Pick List', 'Status', 'Checkbox', 'Date Changed'] },
    { name: SHEET_SLEEVE_SWAPS, headers: ['Employee', 'Item Number', 'Size', 'Date Assigned', 'Change Out Date', 'Days Left', 'Pick List', 'Status', 'Checkbox', 'Date Changed'] },
    { name: SHEET_PURCHASE_NEEDS, headers: ['Item Type', 'Size', 'Class', 'Quantity Needed', 'Reason', 'Status/Notes'] },
    { name: SHEET_INVENTORY_REPORTS, headers: ['Report Type', 'Class', 'Location', 'Count', 'Notes'] },
    { name: SHEET_RECLAIMS, headers: ['Location', 'Approval Status', 'Employee', 'Item Number', 'Class', 'Action Needed'] },
    { name: SHEET_HISTORY, headers: ['Timestamp', 'Action', 'Item Type', 'Item Number', 'Employee', 'Old Value', 'New Value', 'User', 'Source/Notes'] }
  ];
  sheetDefs.forEach(def => {
    let sheet = ss.getSheetByName(def.name);
    if (!sheet) {
      sheet = ss.insertSheet(def.name);
      sheet.getRange(1, 1, 1, def.headers.length).setValues([def.headers]);
    } else if ([SHEET_EMPLOYEES, SHEET_GLOVES, SHEET_SLEEVES].includes(def.name)) {
      // Only set headers if sheet is empty (no data)
      if (sheet.getLastRow() === 0) {
        sheet.getRange(1, 1, 1, def.headers.length).setValues([def.headers]);
      }
      // Do not clear or overwrite any data
    } else {
      sheet.clear();
      sheet.getRange(1, 1, 1, def.headers.length).setValues([def.headers]);
    }
    // Formatting for Employees, Gloves, Sleeves
    if ([SHEET_EMPLOYEES, SHEET_GLOVES, SHEET_SLEEVES].includes(def.name)) {
      sheet.setFrozenRows(1);
      sheet.setFrozenColumns(1);
      var headerRange = sheet.getRange(1, 1, 1, def.headers.length);
      headerRange.setBackground('#1565c0'); // Blue
      headerRange.setFontColor('#ffffff'); // White
      headerRange.setFontWeight('bold');
      var lastRow = sheet.getLastRow();
      var lastCol = def.headers.length;
      if (lastRow > 1) {
        sheet.getRange(2, 1, lastRow - 1, lastCol).setHorizontalAlignment('center');
      }
      // Center header row too
      headerRange.setHorizontalAlignment('center');
    }
    // Formatting for Glove Swaps, Sleeve Swaps
    if ([SHEET_GLOVE_SWAPS, SHEET_SLEEVE_SWAPS].includes(def.name)) {
      var swapSheet = sheet;
      var swapHeaders = def.headers.length;
      swapSheet.getRange(1, 1, 1, swapHeaders).setHorizontalAlignment('center');
      var swapLastRow = swapSheet.getLastRow();
      if (swapLastRow > 1) {
        swapSheet.getRange(2, 1, swapLastRow - 1, swapHeaders).setHorizontalAlignment('center');
      }
    }
  });
  logEvent('Sheets built or reset.');
}

/**
 * Utility to insert the 'Picked For' column if not present in Gloves and Sleeves tabs.
 */
function ensurePickedForColumn() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  [SHEET_GLOVES, SHEET_SLEEVES].forEach(function(sheetName) {
    var sheet = ss.getSheetByName(sheetName);
    if (!sheet) return;
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    if (headers[9] !== 'Picked For') {
      sheet.insertColumnAfter(9);
      sheet.getRange(1, 10).setValue('Picked For').setFontWeight('bold').setBackground('#1565c0').setFontColor('#ffffff').setHorizontalAlignment('center');
    }
  });
}

/**
 * Utility to insert the 'Picked For' column in the Glove Swaps tab.
 */
function ensureGloveSwapsPickedForColumn() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var swapSheet = ss.getSheetByName(SHEET_GLOVE_SWAPS);
  if (!swapSheet) return;
  var headers = swapSheet.getRange(1, 1, 1, swapSheet.getLastColumn()).getValues()[0];
  // Column P is 16th (1-based), Q is 17th
  if (headers[15] !== 'Picked Date') {
    swapSheet.insertColumnAfter(15);
    swapSheet.getRange(1, 16).setValue('Picked Date').setFontWeight('bold').setBackground(HEADER_BG_COLOR).setFontColor('white').setHorizontalAlignment('center');
  } else {
    swapSheet.getRange(1, 16).setValue('Picked Date').setFontWeight('bold').setBackground(HEADER_BG_COLOR).setFontColor('white').setHorizontalAlignment('center');
  }
  if (headers[16] !== 'Picked For') {
    swapSheet.insertColumnAfter(16);
    swapSheet.getRange(1, 17).setValue('Picked For').setFontWeight('bold').setBackground(HEADER_BG_COLOR).setFontColor('white').setHorizontalAlignment('center');
  } else {
    swapSheet.getRange(1, 17).setValue('Picked For').setFontWeight('bold').setBackground(HEADER_BG_COLOR).setFontColor('white').setHorizontalAlignment('center');
  }
}

// Call this in onOpen and buildSheets
function onOpen() {
  ensurePickedForColumn();
  ensureGloveSwapsPickedForColumn();
  SpreadsheetApp.getUi()
    .createMenu('Glove Manager')
    .addItem('Build Sheets', 'buildSheets')
    .addItem('Generate All Reports', 'generateAllReports')
    .addSeparator()
    .addItem('Generate Glove Swaps', 'generateGloveSwaps')
    .addItem('Generate Sleeve Swaps', 'generateSleeveSwaps')
    .addItem('Update Purchase Needs', 'updatePurchaseNeeds')
    .addItem('Update Inventory Reports', 'updateInventoryReports')
    .addItem('Run Reclaims Check', 'runReclaimsCheck')
    .addItem('View History', 'viewHistory')
    .addToUi();
}

/**
 * Logging utility for consistent logs and error tracking.
 */
function logEvent(message, level = 'INFO') {
  const now = new Date();
  Logger.log(`[${level}] [${now.toISOString()}] ${message}`);
}

/**
 * Idempotently creates all required sheets/tabs and headers for the Glove Manager system.
 */
function buildSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetDefs = [
    { name: SHEET_EMPLOYEES, headers: ['Name', 'Class', 'Location', 'Job Number', 'Phone Number', 'Notification Emails', 'MP Email', 'Email Address', 'Glove Size', 'Sleeve Size'] },
    { name: SHEET_GLOVES, headers: ['Glove', 'Size', 'Class', 'Test Date', 'Date Assigned', 'Location', 'Status', 'Assigned To', 'Change Out Date', 'Notes'] },
    { name: SHEET_SLEEVES, headers: ['Sleeve', 'Size', 'Class', 'Test Date', 'Date Assigned', 'Location', 'Status', 'Assigned To', 'Change Out Date', 'Notes'] },
    { name: SHEET_GLOVE_SWAPS, headers: ['Employee', 'Item Number', 'Size', 'Date Assigned', 'Change Out Date', 'Days Left', 'Pick List', 'Status', 'Checkbox', 'Date Changed'] },
    { name: SHEET_SLEEVE_SWAPS, headers: ['Employee', 'Item Number', 'Size', 'Date Assigned', 'Change Out Date', 'Days Left', 'Pick List', 'Status', 'Checkbox', 'Date Changed'] },
    { name: SHEET_PURCHASE_NEEDS, headers: ['Item Type', 'Size', 'Class', 'Quantity Needed', 'Reason', 'Status/Notes'] },
    { name: SHEET_INVENTORY_REPORTS, headers: ['Report Type', 'Class', 'Location', 'Count', 'Notes'] },
    { name: SHEET_RECLAIMS, headers: ['Location', 'Approval Status', 'Employee', 'Item Number', 'Class', 'Action Needed'] },
    { name: SHEET_HISTORY, headers: ['Timestamp', 'Action', 'Item Type', 'Item Number', 'Employee', 'Old Value', 'New Value', 'User', 'Source/Notes'] }
  ];
  sheetDefs.forEach(def => {
    let sheet = ss.getSheetByName(def.name);
    if (!sheet) {
      sheet = ss.insertSheet(def.name);
      sheet.getRange(1, 1, 1, def.headers.length).setValues([def.headers]);
    } else if ([SHEET_EMPLOYEES, SHEET_GLOVES, SHEET_SLEEVES].includes(def.name)) {
      // Only set headers if sheet is empty (no data)
      if (sheet.getLastRow() === 0) {
        sheet.getRange(1, 1, 1, def.headers.length).setValues([def.headers]);
      }
      // Do not clear or overwrite any data
    } else {
      sheet.clear();
      sheet.getRange(1, 1, 1, def.headers.length).setValues([def.headers]);
    }
    // Formatting for Employees, Gloves, Sleeves
    if ([SHEET_EMPLOYEES, SHEET_GLOVES, SHEET_SLEEVES].includes(def.name)) {
      sheet.setFrozenRows(1);
      sheet.setFrozenColumns(1);
      var headerRange = sheet.getRange(1, 1, 1, def.headers.length);
      headerRange.setBackground('#1565c0'); // Blue
      headerRange.setFontColor('#ffffff'); // White
      headerRange.setFontWeight('bold');
      var lastRow = sheet.getLastRow();
      var lastCol = def.headers.length;
      if (lastRow > 1) {
        sheet.getRange(2, 1, lastRow - 1, lastCol).setHorizontalAlignment('center');
      }
      // Center header row too
      headerRange.setHorizontalAlignment('center');
    }
    // Formatting for Glove Swaps, Sleeve Swaps
    if ([SHEET_GLOVE_SWAPS, SHEET_SLEEVE_SWAPS].includes(def.name)) {
      var swapSheet = sheet;
      var swapHeaders = def.headers.length;
      swapSheet.getRange(1, 1, 1, swapHeaders).setHorizontalAlignment('center');
      var swapLastRow = swapSheet.getLastRow();
      if (swapLastRow > 1) {
        swapSheet.getRange(2, 1, swapLastRow - 1, swapHeaders).setHorizontalAlignment('center');
      }
    }
  });
  logEvent('Sheets built or reset.');
}

/**
 * Updates the Location (F) column in the Gloves tab based on Assigned To (H), referencing Employees tab (A: Name, C: Location).
 * If Assigned To matches any name in Employees tab (including non-employee states), set Location to that row's location.
 * Otherwise, leave as is.
 */
function updateGlovesLocationsFromAssignedTo() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var glovesSheet = ss.getSheetByName(SHEET_GLOVES);
  var employeesSheet = ss.getSheetByName(SHEET_EMPLOYEES);
  if (!glovesSheet || !employeesSheet) return;
  var glovesData = glovesSheet.getDataRange().getValues();
  var employeesData = employeesSheet.getDataRange().getValues();
  if (glovesData.length < 2 || employeesData.length < 2) return;
  // Build a map of all names (lowercase, trimmed) to location from Employees tab
  var nameToLocMap = {};
  for (var i = 1; i < employeesData.length; i++) {
    var name = (employeesData[i][0] || '').toString().trim().toLowerCase();
    var loc = employeesData[i][2] || '';
    if (name) nameToLocMap[name] = loc;
  }
  // For each glove row, update Location (F) if Assigned To matches any name in Employees tab
  for (var j = 1; j < glovesData.length; j++) {
    var assignedTo = (glovesData[j][7] || '').toString().trim().toLowerCase(); // H
    if (assignedTo && nameToLocMap.hasOwnProperty(assignedTo)) {
      glovesSheet.getRange(j+1, 6).setValue(nameToLocMap[assignedTo]); // F
    }
  }
}

// Utility: Escape regex special characters in a string
function escapeRegExp(str) {
  // Escape regex special characters for Apps Script compatibility
  return str.replace(/([\\^$*+?.()|{}\[\]])/g, '\\$1');
}

/**
 * Placeholder: Generate Glove Swaps report.
 * Uses Employees and Gloves data to determine upcoming swaps.
 */
function generateGloveSwaps() {
  try {
    logEvent('Generating Glove Swaps report...');
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var swapSheet = ss.getSheetByName(SHEET_GLOVE_SWAPS);
    swapSheet.clear();
    var currentRow = 1;
    var classes = [0, 2, 3];
    var classNames = {0: 'Class 0', 2: 'Class 2', 3: 'Class 3'};
    var today = new Date();

    // List of non-employee names to ignore
    var ignoreNames = [
      'on shelf', 'in testing', 'packed for delivery', 'packed for testing',
      'failed rubber', 'lost', 'not repairable', '', 'n/a', 'ready for test', 'ready for delivery', 'assigned', 'destroyed'
    ];

    // Read Employees and Gloves data
    var employeesSheet = ss.getSheetByName(SHEET_EMPLOYEES);
    var glovesSheet = ss.getSheetByName(SHEET_GLOVES);
    var employees = employeesSheet.getDataRange().getValues();
    var gloves = glovesSheet.getDataRange().getValues();
    if (employees.length < 2 || gloves.length < 2) {
      Logger.log('No data in Employees or Gloves');
      return;
    }
    var empHeaders = employees[0];
    var gloveHeaders = gloves[0];
    var empData = employees.slice(1);
    var gloveData = gloves.slice(1);

    // Build a map of employee name (trimmed, lower) to their info for quick lookup, ignoring non-employee names
    var empMap = {};
    empData.forEach(function(row) {
      var name = (row[0] || '').toString().trim().toLowerCase();
      if (name && ignoreNames.indexOf(name) === -1) {
        empMap[name] = row;
      }
    });

    // For each class, build a table
    classes.forEach(function(gloveClass) {
      // Table title
      swapSheet.getRange(currentRow, 1, 1, 10).merge().setValue(classNames[gloveClass] + ' Glove Swaps');
      swapSheet.getRange(currentRow, 1, 1, 10)
        .setFontWeight('bold').setFontSize(12).setBackground('#e3eafc').setFontColor('#0d47a1').setHorizontalAlignment('center');
      currentRow++;
      // Table headers (visible only)
      var visibleHeaders = [
        'Employee', 'Current Glove #', 'Size', 'Date Assigned', 'Change Out Date', 'Days Left', 'Pick List', 'Status', 'Picked', 'Date Changed',
        'Status', 'Assigned To', 'Date Assigned', // K-M (Stage 1)
        'Status', 'Assigned To', 'Date Assigned', // N-P (Stage 2)
        'Picked For',                             // Q
        'Status', 'Assigned To', 'Date Assigned', // R-T (Stage 3)
        'Assigned To', 'Date Assigned', 'Change Out Date' // U-W (Old Assignment)
      ];
      swapSheet.getRange(currentRow, 1, 1, visibleHeaders.length).setValues([visibleHeaders]);
      swapSheet.getRange(currentRow, 1, 1, visibleHeaders.length)
        .setFontWeight('bold').setFontColor('#ffffff').setHorizontalAlignment('center').setBackground(HEADER_BG_COLOR);
      currentRow++;
      // Only add swapRows below the header row
      var swapRows = [];
      var daysLeftStyles = [];
      var swapMeta = [];
      // Gather all swap candidates for this class
      gloveData.forEach(function(glove) {
        if (parseInt(glove[2], 10) !== gloveClass) return;
        var assignedTo = (glove[7] || '').toString().trim().toLowerCase();
        if (!assignedTo || ignoreNames.indexOf(assignedTo) !== -1 || !empMap[assignedTo]) {
          return;
        }
        var emp = empMap[assignedTo];
        var itemNum = glove[0];
        var size = glove[1];
        var dateAssigned = glove[4];
        var changeOutDate = glove[8];
        var status = glove[6];
        // Calculate Days Left and status
        var daysLeft = '';
        var daysLeftCell = {};
        var days = null;
        if (changeOutDate && !isNaN(new Date(changeOutDate))) {
          var diff = (new Date(changeOutDate) - today) / (1000*60*60*24);
          days = Math.ceil(diff);
          if (days < 0) {
            daysLeft = 'OVERDUE';
            daysLeftCell = {bold: true, color: '#ff5252'};
          } else if (days <= 14) {
            daysLeft = days;
            daysLeftCell = {bold: true, color: '#ff9800'};
          } else {
            daysLeft = days;
            daysLeftCell = {bold: false, color: '#388e3c'};
          }
        }
        // Only show if assigned, has a change out date, and due in next month
        if (dateAssigned && changeOutDate && daysLeft !== '' && ((typeof daysLeft === 'number' && daysLeft < 32) || daysLeft === 'OVERDUE')) {
          swapMeta.push({
            emp: emp,
            itemNum: itemNum,
            size: size,
            dateAssigned: dateAssigned,
            changeOutDate: changeOutDate,
            daysLeft: daysLeft,
            daysLeftCell: daysLeftCell,
            status: status,
            gloveClass: gloveClass,
            empPreferredSize: emp[8],
            gloveSizeNum: parseFloat(size)
          });
        }
      });
      // Sort swapMeta by soonest Change Out Date (ascending)
      swapMeta.sort(function(a, b) {
        var da = new Date(a.changeOutDate);
        var db = new Date(b.changeOutDate);
        return da - db;
      });
      // Track assigned glove item numbers to prevent duplicates
      var assignedGloveNums = new Set();
      // For each swap row, assign Pick List and Status
      swapMeta.forEach(function(meta) {
        var emp = meta.emp;
        var useSize = !isNaN(parseFloat(meta.empPreferredSize)) ? parseFloat(meta.empPreferredSize) : meta.gloveSizeNum;
        var pickListValue = 'â€”';
        var found = false;
        var pickListStatus = '';
        var pickListSizeUp = false;
        var pickListStatusRaw = '';
        var pickListSize = null;
        var pickListManual = false;
        var pickListManualValue = null;
        // 1. On Shelf, exact size
        var match = gloveData.find(function(g) {
          return g[6] && g[6].toString().trim().toLowerCase() === 'on shelf' &&
                 parseInt(g[2], 10) === meta.gloveClass &&
                 parseFloat(g[1]) === useSize &&
                 !assignedGloveNums.has(g[0]);
        });
        if (match) {
          pickListValue = match[0];
          pickListStatusRaw = 'on shelf';
          pickListSize = parseFloat(match[1]);
          assignedGloveNums.add(match[0]);
          found = true;
        }
        // 2. On Shelf, upsize +0.5 only
        if (!found && !isNaN(useSize)) {
          match = gloveData.find(function(g) {
            return g[6] && g[6].toString().trim().toLowerCase() === 'on shelf' &&
                   parseInt(g[2], 10) === meta.gloveClass &&
                   parseFloat(g[1]) === useSize + 0.5 &&
                   !assignedGloveNums.has(g[0]);
          });
          if (match) {
            pickListValue = match[0];
            pickListStatusRaw = 'on shelf';
            pickListSize = parseFloat(match[1]);
            pickListSizeUp = true;
            assignedGloveNums.add(match[0]);
            found = true;
          }
        }
        // 3. Ready For Delivery/In Testing, exact size
        if (!found) {
          match = gloveData.find(function(g) {
            var stat = g[6] && g[6].toString().trim().toLowerCase();
            return (stat === 'ready for delivery' || stat === 'in testing') &&
                   parseInt(g[2], 10) === meta.gloveClass &&
                   parseFloat(g[1]) === useSize &&
                   !assignedGloveNums.has(g[0]);
          });
          if (match) {
            pickListValue = match[0];
            pickListStatusRaw = match[6].toString().trim().toLowerCase();
            pickListSize = parseFloat(match[1]);
            assignedGloveNums.add(match[0]);
            found = true;
          }
        }
        // 4. Ready For Delivery/In Testing, upsize +0.5 only
        if (!found && !isNaN(useSize)) {
          match = gloveData.find(function(g) {
            var stat = g[6] && g[6].toString().trim().toLowerCase();
            return (stat === 'ready for delivery' || stat === 'in testing') &&
                   parseInt(g[2], 10) === meta.gloveClass &&
                   parseFloat(g[1]) === useSize + 0.5 &&
                   !assignedGloveNums.has(g[0]);
          });
          if (match) {
            pickListValue = match[0];
            pickListStatusRaw = match[6].toString().trim().toLowerCase();
            pickListSize = parseFloat(match[1]);
            pickListSizeUp = true;
            assignedGloveNums.add(match[0]);
            found = true;
          }
        }
        // Status logic for auto-assigned Pick List
        if (pickListValue === 'â€”') {
          pickListStatus = 'Need to Purchase âŒ';
        } else if (pickListStatusRaw === 'on shelf') {
          pickListStatus = pickListSizeUp ? 'In Stock (Size Up) âš ï¸' : 'In Stock âœ…';
        } else if (pickListStatusRaw === 'ready for delivery') {
          pickListStatus = pickListSizeUp ? 'Ready For Delivery (Size Up) âš ï¸' : 'Ready For Delivery ðŸšš';
        } else if (pickListStatusRaw === 'in testing') {
          pickListStatus = pickListSizeUp ? 'In Testing (Size Up) âš ï¸' : 'In Testing â³';
        } else {
          pickListStatus = '';
        }
        swapRows.push([
          emp[0],    // Employee (original case)
          meta.itemNum,   // Current Glove #
          meta.size,      // Size
          meta.dateAssigned, // Date Assigned
          meta.changeOutDate, // Change Out Date
          meta.daysLeft,  // Days Left (now includes status text)
          pickListValue, // Pick List (auto, may be overridden after)
          pickListStatus, // Status (auto, may be overridden after)
          false,     // Picked (checkbox placeholder)
          ''         // Date Changed (placeholder)
        ]);
        daysLeftStyles.push(meta.daysLeftCell);
      });
      if (swapRows.length > 0) {
        swapSheet.getRange(currentRow, 1, swapRows.length, 10).setValues(swapRows);
        swapSheet.getRange(currentRow, 1, swapRows.length, 10).setHorizontalAlignment('center');
        // Add checkboxes to Picked column (I)
        swapSheet.getRange(currentRow, 9, swapRows.length, 1).insertCheckboxes();
        // Apply formatting to Days Left column (F/6)
        var daysLeftRange = swapSheet.getRange(currentRow, 6, swapRows.length, 1);
        for (var i = 0; i < swapRows.length; i++) {
          var val = swapRows[i][5];
          var style = daysLeftStyles[i];
          if (val === 'OVERDUE') {
            daysLeftRange.getCell(i+1,1).setFontWeight('bold').setFontColor(style.color);
          } else if (typeof val === 'number' || (val && !isNaN(val))) {
            if (style.bold) {
              daysLeftRange.getCell(i+1,1).setFontWeight('bold').setFontColor(style.color);
            } else {
              daysLeftRange.getCell(i+1,1).setFontWeight('normal').setFontColor(style.color);
            }
          } else {
            daysLeftRange.getCell(i+1,1).setFontWeight('normal').setFontColor('#388e3c');
          }
        }
        // Manual override detection for Pick List (G/7):
        var pickListRange = swapSheet.getRange(currentRow, 7, swapRows.length, 1);
        var pickListValues = pickListRange.getValues();
        var statusRange = swapSheet.getRange(currentRow, 8, swapRows.length, 1);
        for (var i = 0; i < swapRows.length; i++) {
          var autoVal = swapRows[i][6];
          var userVal = pickListValues[i][0];
          var statusVal = swapRows[i][7];
          // If manual override, recalculate status for the override
          if (userVal !== autoVal && userVal !== '' && userVal !== 'â€”') {
            pickListRange.getCell(i+1,1).setBackground('#e3f2fd');
            // Find the glove in the inventory for the override value
            var overrideGlove = gloveData.find(function(g) { return g[0] == userVal; });
            var overrideStatus = 'Need to Purchase âŒ';
            if (overrideGlove) {
              var overrideStatusRaw = overrideGlove[6] ? overrideGlove[6].toString().trim().toLowerCase() : '';
              var overrideSize = parseFloat(overrideGlove[1]);
              var empPrefSize = !isNaN(parseFloat(swapMeta[i].empPreferredSize)) ? parseFloat(swapMeta[i].empPreferredSize) : parseFloat(swapMeta[i].gloveSizeNum);
              var isSizeUp = (overrideSize === empPrefSize + 0.5);
              if (overrideStatusRaw === 'on shelf') {
                overrideStatus = isSizeUp ? 'In Stock (Size Up) âš ï¸' : 'In Stock âœ…';
              } else if (overrideStatusRaw === 'ready for delivery') {
                overrideStatus = isSizeUp ? 'Ready For Delivery (Size Up) âš ï¸' : 'Ready For Delivery ðŸšš';
              } else if (overrideStatusRaw === 'in testing') {
                overrideStatus = isSizeUp ? 'In Testing (Size Up) âš ï¸' : 'In Testing â³';
              }
            }
            statusRange.getCell(i+1,1).setValue(overrideStatus);
          } else {
            // Not overridden, set to auto value and clear highlight
            pickListRange.getCell(i+1,1).setValue(autoVal).setBackground('#ffffff');
            statusRange.getCell(i+1,1).setValue(statusVal);
          }
          // --- NEW LOGIC: Populate K-M with glove info for Pick List value ---
          var pickListItemNum = pickListRange.getCell(i+1,1).getValue();
          if (pickListItemNum && pickListItemNum !== 'â€”') {
            var gloveRowIdx = gloveData.findIndex(function(g) { return g[0] == pickListItemNum; });
            if (gloveRowIdx > -1) {
              var gloveRow = gloveData[gloveRowIdx];
              var gloveStatus = gloveRow[6];
              var gloveAssignedTo = gloveRow[7];
              var gloveDateAssigned = gloveRow[4];
              swapSheet.getRange(currentRow + i, 11, 1, 3).setValues([[gloveStatus, gloveAssignedTo, gloveDateAssigned]]);
            }
          }
        }
        currentRow += swapRows.length;
      } else {
        Logger.log('No swap rows to write for class ' + gloveClass);
      }
      currentRow += 2; // Add space between tables
    });
    updateGlovesLocationsFromAssignedTo();
  } catch (e) {
    logEvent('Error in generateGloveSwaps: ' + e, 'ERROR');
    throw e;
  }
}

/**
 * Placeholder: Generate Sleeve Swaps report.
 * Uses Employees and Sleeves data to determine upcoming swaps.
 */
function generateSleeveSwaps() {
  try {
    logEvent('Generating Sleeve Swaps report...');
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var swapSheet = ss.getSheetByName(SHEET_SLEEVE_SWAPS);
    swapSheet.clear();
    writeSwapTableHeadersDynamic(swapSheet, 1, 'Sleeves', '#ffffff', 3);
    // TODO: Add logic to populate swap data
  } catch (e) {
    logEvent('Error in generateSleeveSwaps: ' + e, 'ERROR');
    throw e;
  }
}

/**
 * Placeholder: Update Purchase Needs report.
 * Aggregates Gloves and Sleeves data to identify shortages.
 */
function updatePurchaseNeeds() {
  try {
    logEvent('Updating Purchase Needs report...');
    // TODO: Implement logic
  } catch (e) {
    logEvent('Error in updatePurchaseNeeds: ' + e, 'ERROR');
    throw e;
  }
}

/**
 * Placeholder: Update Inventory Reports.
 * Summarizes inventory status from Gloves and Sleeves.
 */
function updateInventoryReports() {
  try {
    logEvent('Updating Inventory Reports...');
    // TODO: Implement logic
  } catch (e) {
    logEvent('Error in updateInventoryReports: ' + e, 'ERROR');
    throw e;
  }
}

/**
 * Placeholder: Run Reclaims check.
 * Cross-checks assignments for compliance with location rules.
 */
function runReclaimsCheck() {
  try {
    logEvent('Running Reclaims check...');
    // TODO: Implement logic
  } catch (e) {
    logEvent('Error in runReclaimsCheck: ' + e, 'ERROR');
    throw e;
  }
}

/**
 * Placeholder: View History log.
 * Displays or exports the audit trail of all changes.
 */
function viewHistory() {
  try {
    logEvent('Viewing History log...');
    // TODO: Implement logic
  } catch (e) {
    logEvent('Error in viewHistory: ' + e, 'ERROR');
    throw e;
  }
}

/**
 * Calls all report-generation/update functions to refresh all reports/tabs.
 */
function generateAllReports() {
  try {
    logEvent('Generating all reports...');
    generateGloveSwaps();
    generateSleeveSwaps();
    updatePurchaseNeeds();
    updateInventoryReports();
    runReclaimsCheck();
    viewHistory();
    logEvent('All reports generated.');
  } catch (e) {
    logEvent('Error in generateAllReports: ' + e, 'ERROR');
    throw e;
  }
}

/**
 * Event-driven handler for Glove Swaps multi-stage workflow.
 * Handles Picked checkbox and Date Changed logic, including state storage, inventory updates, and UI feedback.
 * Idempotent and robust to user edits and script re-runs.
 */
function onEdit(e) {
  var range = e.range;
  var sheet = range.getSheet();
  var sheetName = sheet.getName();
  if (sheetName !== SHEET_GLOVE_SWAPS) return;

  var row = range.getRow();
  var col = range.getColumn();
  var headersRow = 0;
  // Find the header row for this table (look up for 'Employee' header)
  for (var r = row; r > 0; r--) {
    if ((sheet.getRange(r, 1).getValue() + '').toLowerCase() === 'employee') {
      headersRow = r;
      break;
    }
  }
  if (!headersRow || row <= headersRow) return; // Not a data row

  var pickedCol = 9; // I
  var dateChangedCol = 10; // J
  var pickListCol = 7; // G
  var statusCol = 8; // H
  var daysLeftCol = 6; // F
  var stage1StartCol = 11; // K
  var stage2StartCol = 14; // N
  var stage3StartCol = 17; // Q (now R)
  var oldAssignCol = 20; // T (now U)
  var pickedDateColSwap = 16; // P (Picked Date)
  var pickedForColSwap = 17; // Q (Picked For)

  var picked = sheet.getRange(row, pickedCol).getValue();
  var pickList = sheet.getRange(row, pickListCol).getValue();
  var emp = sheet.getRange(row, 1).getValue();
  var itemNum = sheet.getRange(row, 2).getValue();
  var size = sheet.getRange(row, 3).getValue();
  var dateAssigned = sheet.getRange(row, 4).getValue();
  var changeOutDate = sheet.getRange(row, 5).getValue();
  var status = sheet.getRange(row, statusCol).getValue();
  var daysLeft = sheet.getRange(row, daysLeftCol).getValue();
  var dateChanged = sheet.getRange(row, dateChangedCol).getValue();

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var glovesSheet = ss.getSheetByName(SHEET_GLOVES);
  var glovesData = glovesSheet.getDataRange().getValues();
  var glovesHeaders = glovesData[0];
  var pickedForColGloves = 10; // J (Gloves tab)

  // Prevent Date Changed from being entered unless Picked is checked
  if (col === dateChangedCol) {
    if (!picked && dateChanged) {
      // Clear the Date Changed value and optionally show a warning
      sheet.getRange(row, dateChangedCol).setValue('');
      SpreadsheetApp.getUi().alert('You must check the Picked box before entering a Date Changed value.');
      return;
    }
  }

  // Helper to find glove row in inventory
  function findGloveRow(itemNum) {
    for (var i = 1; i < glovesData.length; i++) {
      if (glovesData[i][0] == itemNum) return i + 1;
    }
    return null;
  }

  // Stage 1: When Pick List is assigned (auto or manual), store current glove info in K-M
  if (col === pickListCol && pickList && pickList !== 'â€”') {
    var gloveRow = findGloveRow(pickList);
    if (gloveRow) {
      var gloveStatus = glovesSheet.getRange(gloveRow, 7).getValue();
      var gloveAssignedTo = glovesSheet.getRange(gloveRow, 8).getValue();
      var gloveDateAssigned = glovesSheet.getRange(gloveRow, 5).getValue();
      sheet.getRange(row, stage1StartCol, 1, 3).setValues([[gloveStatus, gloveAssignedTo, gloveDateAssigned]]);
    }
  }

  // Stage 2: Picked checkbox checked
  if (col === pickedCol && picked === true && pickList && pickList !== 'â€”') {
    var now = new Date();
    var dateStr = Utilities.formatDate(now, ss.getSpreadsheetTimeZone(), 'yyyy-MM-dd');
    var statusAfter = 'Ready For Delivery ðŸšš';
    var assignedToAfter = 'Packed For Delivery';
    sheet.getRange(row, statusCol).setValue(statusAfter); // Update Status (H) in UI
    sheet.getRange(row, stage2StartCol, 1, 3).setValues([
      [statusAfter, assignedToAfter, dateStr]
    ]);
    var gloveRow = findGloveRow(pickList);
    if (gloveRow) {
      glovesSheet.getRange(gloveRow, 7).setValue('Ready For Delivery'); // Status (G)
      glovesSheet.getRange(gloveRow, 8).setValue(assignedToAfter); // Assigned To (H)
      glovesSheet.getRange(gloveRow, 5).setValue(dateStr); // Date Assigned (E)
      glovesSheet.getRange(gloveRow, 9).setValue(changeOutDate); // Change Out Date (I)
      glovesSheet.getRange(gloveRow, pickedForColGloves).setValue(emp + ' Picked On ' + dateStr);
    }
    sheet.getRange(row, pickedDateColSwap).setValue(dateStr);
    sheet.getRange(row, pickedForColSwap).setValue(emp);
  }
  // Stage 1 Revert: Picked checkbox unchecked
  else if (col === pickedCol && picked === false) {
    var prevStatus = sheet.getRange(row, stage1StartCol).getValue();
    var prevEmp = sheet.getRange(row, stage1StartCol + 1).getValue();
    var prevDateAssigned = sheet.getRange(row, stage1StartCol + 2).getValue();
    var gloveRow = findGloveRow(pickList);
    if (gloveRow) {
      glovesSheet.getRange(gloveRow, 7).setValue(prevStatus); // Status (G)
      glovesSheet.getRange(gloveRow, 8).setValue(prevEmp);    // Assigned To (H)
      glovesSheet.getRange(gloveRow, 5).setValue(prevDateAssigned); // Date Assigned (E)
      glovesSheet.getRange(gloveRow, pickedForColGloves).setValue(''); // Picked For (J)
    }
    // Revert Status (H) in Glove Swaps tab to previous value from K
    sheet.getRange(row, statusCol).setValue(prevStatus).setFontWeight('normal').setFontColor('black');
    sheet.getRange(row, stage2StartCol, 1, 3).clearContent();
    sheet.getRange(row, pickedDateColSwap).setValue('');
    sheet.getRange(row, pickedForColSwap).setValue('');
  }
  // Stage 3: Date Changed entered (finalize swap, not changed here)
  else if (col === dateChangedCol && pickList && pickList !== 'â€”') {
    var gloveRow = findGloveRow(pickList);
    var prevStatus = sheet.getRange(row, stage1StartCol).getValue();
    var prevAssignedTo = sheet.getRange(row, stage1StartCol + 1).getValue();
    var prevDateAssigned = sheet.getRange(row, stage1StartCol + 2).getValue();
    var oldGloveNum = sheet.getRange(row, 2).getValue(); // Column B: Current Glove # (Old Glove)
    var oldGloveRow = findGloveRow(oldGloveNum);
    if (dateChanged) {
      sheet.getRange(row, stage3StartCol, 1, 3).setValues([[prevStatus, prevAssignedTo, prevDateAssigned]]); // R-T
      sheet.getRange(row, oldAssignCol, 1, 3).setValues([[prevAssignedTo, prevDateAssigned, changeOutDate]]); // U-W
      sheet.getRange(row, stage2StartCol, 1, 3).setValues([[status, emp, dateChanged]]);
      if (gloveRow) {
        glovesSheet.getRange(gloveRow, 7).setValue('Assigned');
        glovesSheet.getRange(gloveRow, 8).setValue(emp);
        glovesSheet.getRange(gloveRow, 5).setValue(dateChanged);
        glovesSheet.getRange(gloveRow, pickedForColGloves).setValue('');
      }
      // --- Update Old Glove (column B) ---
      if (oldGloveRow) {
        glovesSheet.getRange(oldGloveRow, 5).setValue(dateChanged); // Date Assigned (E)
        glovesSheet.getRange(oldGloveRow, 8).setValue('Packed For Testing'); // Assigned To (H)
      }
      sheet.getRange(row, statusCol).setValue('Assigned').setFontWeight('bold').setFontColor('#388e3c');
      var daysLeftCell = sheet.getRange(row, daysLeftCol);
      if (daysLeftCell.getValue() === 'OVERDUE') {
        daysLeftCell.setValue('Assigned').setFontWeight('bold').setFontColor('#388e3c');
      }
      var historySheet = ss.getSheetByName(SHEET_HISTORY);
      if (historySheet) {
        historySheet.appendRow([
          new Date(),
          'Glove Swap Finalized',
          'Glove',
          pickList,
          emp,
          prevStatus,
          'Assigned',
          Session.getActiveUser().getEmail(),
          'Auto-logged by script'
        ]);
      }
    } else {
      // Date Changed was removed: revert all Stage 3/Old Assignment, restore UI and Gloves tab
      sheet.getRange(row, stage3StartCol, 1, 3).clearContent();
      sheet.getRange(row, oldAssignCol, 1, 3).clearContent();
      if (picked) {
        // Restore N-P to 'Ready For Delivery' state
        var now = new Date();
        var dateStr = Utilities.formatDate(now, ss.getSpreadsheetTimeZone(), 'yyyy-MM-dd');
        var statusAfter = 'Ready For Delivery ðŸšš';
        var assignedToAfter = 'Packed For Delivery';
        sheet.getRange(row, stage2StartCol, 1, 3).setValues([[statusAfter, assignedToAfter, dateStr]]);
        sheet.getRange(row, statusCol).setValue(statusAfter).setFontWeight('normal').setFontColor('black');
        var gloveRow = findGloveRow(pickList);
        if (gloveRow) {
          glovesSheet.getRange(gloveRow, 7).setValue('Ready For Delivery');
          glovesSheet.getRange(gloveRow, 8).setValue(assignedToAfter);
          glovesSheet.getRange(gloveRow, 5).setValue(dateStr);
          glovesSheet.getRange(gloveRow, pickedForColGloves).setValue(emp + ' Picked On ' + dateStr);
        }
        sheet.getRange(row, pickedDateColSwap).setValue(dateStr);
        sheet.getRange(row, pickedForColSwap).setValue(emp);
        // Restore Days Left to original value
        var origChangeOutDate = sheet.getRange(row, 5).getValue();
        if (origChangeOutDate && !isNaN(new Date(origChangeOutDate))) {
          var diff = (new Date(origChangeOutDate) - new Date()) / (1000*60*60*24);
          var days = Math.ceil(diff);
          var daysLeftVal = '';
          var daysLeftStyle = {};
          if (days < 0) {
            daysLeftVal = 'OVERDUE';
            daysLeftStyle = {bold: true, color: '#ff5252'};
          } else if (days <= 14) {
            daysLeftVal = days;
            daysLeftStyle = {bold: true, color: '#ff9800'};
          } else {
            daysLeftVal = days;
            daysLeftStyle = {bold: false, color: '#388e3c'};
          }
          var daysLeftCell = sheet.getRange(row, daysLeftCol);
          daysLeftCell.setValue(daysLeftVal);
          if (daysLeftVal === 'OVERDUE') {
            daysLeftCell.setFontWeight('bold').setFontColor(daysLeftStyle.color);
          } else if (typeof daysLeftVal === 'number' || (daysLeftVal && !isNaN(daysLeftVal))) {
            if (daysLeftStyle.bold) {
              daysLeftCell.setFontWeight('bold').setFontColor(daysLeftStyle.color);
            } else {
              daysLeftCell.setFontWeight('normal').setFontColor(daysLeftStyle.color);
            }
          } else {
            daysLeftCell.setFontWeight('normal').setFontColor('#388e3c');
          }
        }
        // --- Revert Old Glove (column B) to previous values from R-T ---
        if (oldGloveRow) {
          var prevOldStatus = sheet.getRange(row, stage3StartCol).getValue();
          var prevOldAssignedTo = sheet.getRange(row, stage3StartCol + 1).getValue();
          var prevOldDateAssigned = sheet.getRange(row, stage3StartCol + 2).getValue();
          glovesSheet.getRange(oldGloveRow, 7).setValue(prevOldStatus);
          glovesSheet.getRange(oldGloveRow, 8).setValue(prevOldAssignedTo);
          glovesSheet.getRange(oldGloveRow, 5).setValue(prevOldDateAssigned);
        }
      } else {
        // If Picked is not checked, clear N-P and revert to original state
        sheet.getRange(row, stage2StartCol, 1, 3).clearContent();
        var origStatus = sheet.getRange(row, stage1StartCol).getValue();
        sheet.getRange(row, statusCol).setValue(origStatus).setFontWeight('normal').setFontColor('black');
        var prevAssignedTo = sheet.getRange(row, stage1StartCol + 1).getValue();
        var prevDateAssigned = sheet.getRange(row, stage1StartCol + 2).getValue();
        var gloveRow = findGloveRow(pickList);
        if (gloveRow) {
          glovesSheet.getRange(gloveRow, 7).setValue(origStatus);
          glovesSheet.getRange(gloveRow, 8).setValue(prevAssignedTo);
          glovesSheet.getRange(gloveRow, 5).setValue(prevDateAssigned);
          glovesSheet.getRange(gloveRow, pickedForColGloves).setValue('');
        }
        // --- Revert Old Glove (column B) to previous values from R-T ---
        if (oldGloveRow) {
          var prevOldStatus = sheet.getRange(row, stage3StartCol).getValue();
          var prevOldAssignedTo = sheet.getRange(row, stage3StartCol + 1).getValue();
          var prevOldDateAssigned = sheet.getRange(row, stage3StartCol + 2).getValue();
          glovesSheet.getRange(oldGloveRow, 7).setValue(prevOldStatus);
          glovesSheet.getRange(oldGloveRow, 8).setValue(prevOldAssignedTo);
          glovesSheet.getRange(oldGloveRow, 5).setValue(prevOldDateAssigned);
        }
        sheet.getRange(row, pickedDateColSwap).setValue('');
        sheet.getRange(row, pickedForColSwap).setValue('');
      }
    }
  }
  updateGlovesLocationsFromAssignedTo();
}
